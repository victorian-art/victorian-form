<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Victorian Art — النظام الاحترافي (الاجتماعات → القياس → الطلب → الدفعات → التركيب → المشاريع المنفذة)</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.13.0/cdn/themes/light.css"/>
<script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.13.0/cdn/shoelace.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<style>
:root{ --brand:#0B69FF; --accent:#b58e00; --ok:#10b981; --warn:#f59e0b; --danger:#ef4444; --bg:#f7f8fb; --muted:#6b7280; --border:#e5e7eb;}
*{box-sizing:border-box}
body{font-family:system-ui,-apple-system,"Noto Kufi Arabic","Segoe UI",Roboto,Arial,sans-serif;background:var(--bg);margin:0;color:#111}
header{position:sticky;top:0;z-index:50;border-bottom:1px solid #eee;background:#ffffffb8;backdrop-filter:blur(8px)}
.container{max-width:1200px;margin:0 auto;padding:16px}
.grid{display:grid;gap:16px}
.grid-4{grid-template-columns:1.1fr 1fr 1fr 1fr}
@media(max-width:1100px){.grid-4{grid-template-columns:1fr}}
.brand{display:flex;gap:12px;align-items:center}
.pill{padding:4px 10px;border:1px solid var(--border);border-radius:999px;font-size:12px;color:#444;background:#fff}
.row{display:flex;gap:8px;align-items:center}
.hidden{display:none !important}
.muted{color:var(--muted);font-size:12px}
.hr{height:1px;background:var(--border);margin:10px 0}
.empty{padding:16px;background:#fff;border:1px dashed var(--border);border-radius:12px;text-align:center;color:#6b7280}
.cur-card img{max-width:240px;height:auto;border-radius:10px;border:1px solid #eee;margin:4px}
.cur-sum{border:1px solid var(--border);border-radius:12px;padding:10px;margin:8px 0;background:#fff}
.gallery{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:8px}
/* Thumbnails */
.thumb{width:120px;height:auto;border-radius:10px;border:1px solid #eee;margin:4px}
.thumb-sq{width:72px;height:72px;object-fit:cover;border-radius:8px;border:1px solid #eee;margin:3px}
#installList .gallery img{width:120px;height:auto;border-radius:8px;border:1px solid #eee}

.soft{background:#fafafa;border:1px dashed var(--border);border-radius:12px;padding:10px}
.total-box{background:#f3f4f6;border:1px solid var(--border);border-radius:12px;padding:10px}
[dir="rtl"] sl-input::part(base),[dir="rtl"] sl-textarea::part(base),[dir="rtl"] sl-select::part(combobox){text-align:right;}
#dlgSettings sl-input::part(input){direction:ltr;text-align:left}
/* Print */
@media print{ body > *:not(#printScope){display:none !important} 
  header,.no-print,sl-dialog{display:none !important}
  #printScope{display:block !important}
  #printScope img{max-width:8cm;height:auto;margin:4px;display:inline-block}
}
</style>

<!-- Firebase COMPAT SDK (no modules, works everywhere) -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>

<!-- FB compat shim v4: modular API emulation + snapshot wrappers -->
<script>
(function(){
  if(typeof firebase === 'undefined'){ console.error('Firebase SDK not loaded'); return; }
  // ----- Firestore helpers -----
  function _coll(){
    var a=arguments;
    if(a.length===1 && typeof a[0]==='string') return firebase.firestore().collection(a[0]);
    if(a.length>=2 && typeof a[1]==='string') return firebase.firestore().collection(a[1]); // (db,'orders')
    return firebase.firestore().collection(String(a[a.length-1]||'unknown'));
  }
  function _doc(){
    var a=arguments;
    if(a.length===2 && typeof a[0]==='string') return firebase.firestore().collection(a[0]).doc(a[1]);
    if(a.length===3 && typeof a[1]==='string') return firebase.firestore().collection(a[1]).doc(a[2]);
    if(a.length===1 && typeof a[0]==='string'){ var p=String(a[0]).split('/'); if(p.length>=2) return firebase.firestore().collection(p[p.length-2]).doc(p[p.length-1]); }
    if(a[0] && a[0].path && a[0].id){ return a[0]; }
    return null;
  }
  function _orderBy(){ return { __type:'orderBy', args:[].slice.call(arguments) }; }
  function _where(){ return { __type:'where', args:[].slice.call(arguments) }; }
  function _limit(n){ return { __type:'limit', n:n }; }
  function _query(ref){
    var q=ref;
    for(var i=1;i<arguments.length;i++){
      var t = arguments[i]; if(!t) continue;
      if(t.__type==='orderBy'){ q = q.orderBy.apply(q, t.args); }
      if(t.__type==='where'){ q = q.where.apply(q, t.args); }
      if(t.__type==='limit'){ q = q.limit(t.n); }
    }
    return q;
  }
  // ---- Snap wrappers (provide exists() in compat) ----
  function wrapSnap(ds){
    try{
      if(!ds) return ds;
      if(typeof ds.exists === 'function') return ds; // already modular-style
      return new Proxy(ds, { get(target, prop){ if(prop==='exists'){ return function(){ return !!target.exists; }; } return target[prop]; } });
    }catch(_){ return ds; }
  }
  function wrapQuerySnap(qs){
    try{
      if(!qs || typeof qs.forEach!=='function') return qs;
      const docs=[]; qs.forEach(function(d){ docs.push(wrapSnap(d)); });
      return { size: docs.length, empty: docs.length===0, docs: docs, forEach: function(fn){ docs.forEach(fn); }, _orig: qs };
    }catch(_){ return qs; }
  }
  // ----- Storage helpers -----
  function _ref(storageOrPath, maybePath){ var s=firebase.storage(); if(typeof storageOrPath==='string'&&!maybePath) return s.ref(storageOrPath); if(maybePath) return s.ref(maybePath); return s.ref(); }
  function _child(refObj, path){ return refObj.child(path); }
  function _uploadBytes(refObj, data){ return refObj.put(data); }
  function _uploadString(refObj, data, format){ return refObj.putString(data, format||'data_url'); }
  function _getDownloadURL(refObj){ return refObj.getDownloadURL(); }
  function _listAll(refObj){ return refObj.listAll(); }
  function _deleteObject(refObj){ return refObj.delete(); }
  function _getMetadata(refObj){ return refObj.getMetadata(); }
  function _updateMetadata(refObj, meta){ return refObj.updateMetadata(meta); }
  window.FB = {
    initializeApp: firebase.initializeApp,
    getAuth: function(){ return firebase.auth(); },
    onAuthStateChanged: function(auth, cb){ return firebase.auth().onAuthStateChanged(cb); },
    signInWithEmailAndPassword: function(_auth, email, pass){ return firebase.auth().signInWithEmailAndPassword(email, pass); },
    createUserWithEmailAndPassword: function(_auth, email, pass){ return firebase.auth().createUserWithEmailAndPassword(email, pass); },
    signOut: function(){ return firebase.auth().signOut(); },
    getFirestore: function(){ return firebase.firestore(); },
    collection: _coll, docRef: _doc, doc: _doc,
    getDoc: function(doc){ return doc.get().then(wrapSnap); },
    getDocs: function(col){ return col.get().then(wrapQuerySnap); },
    addDoc: function(col, data){ return col.add(data); },
    setDoc: function(doc, data){ return doc.set(data); },
    updateDoc: function(doc, data){ return doc.update(data); },
    deleteDoc: function(doc){ return doc.delete(); },
    onSnapshot: function(ref, cb){ return ref.onSnapshot(function(s){ try{ cb(wrapQuerySnap(s)); }catch(e){ try{ cb(wrapSnap(s)); }catch(_){ cb(s); } } }); },
    orderBy: _orderBy, where: _where, limit: _limit, query: _query,
    arrayUnion: function(){ return firebase.firestore.FieldValue.arrayUnion.apply(null, arguments); },
    serverTimestamp: function(){ return firebase.firestore.FieldValue.serverTimestamp(); },
    getStorage: function(){ return firebase.storage(); },
    ref: _ref, child: _child, uploadBytes: _uploadBytes, uploadString: _uploadString, getDownloadURL: _getDownloadURL, listAll: _listAll, deleteObject: _deleteObject, getMetadata: _getMetadata, updateMetadata: _updateMetadata,
    getDocDoc: function(_db, col, id){ return firebase.firestore().collection(col).doc(id); }
  };
  // Globals
  window.app = window.app || (function(){ try{ return firebase.app(); }catch(_){ return null; } })();
  window.auth = firebase.auth(); window.db = firebase.firestore(); window.storage = firebase.storage();
  try{ window.doc = window.FB.doc; window.ref = window.FB.ref; }catch(_){}
  if(typeof window.toast !== 'function'){ window.toast = function(msg, type){ try{ console.log('[toast]', type||'info', msg); }catch(_){} }; }
  window.addEventListener('error', function(e){ try{ toast('[JS] '+e.message, 'danger'); }catch(_){ console.error(e); } });
  window.addEventListener('unhandledrejection', function(e){ try{ toast('[Promise] '+(e.reason && (e.reason.message||e.reason.code||e.reason)), 'danger'); }catch(_){ console.error(e); } });
  console.log('[FB shim v4] ready');
})();
</script>


</head>
<body>

<header>
  <div class="container" style="display:flex;align-items:center;justify-content:space-between;gap:12px">
    <div class="brand">
      <img src="https://i.postimg.cc/L4QwkTxg/LOGO23333.png" alt="VA" style="width:44px;height:44px;border-radius:12px;object-fit:contain;background:#fff"/>
      <div>
        <div style="font-weight:700">النظام الاحترافي — Victorian Art</div>
        <div class="muted">الاجتماعات → القياس → الطلب → الدفعات → التركيب → المشاريع المنفذة</div>
      </div>
    </div>
    <div class="row">
      <sl-button id="openSettings" size="small" pill><i class="bi bi-gear"></i>&nbsp;إعدادات</sl-button>
      <sl-button id="openDanger" size="small" variant="danger" pill><i class="bi bi-exclamation-triangle"></i>&nbsp;الحذف الشامل</sl-button>
    </div>
  </div>
</header>

<!-- Top Cards -->
<div class="container grid grid-4" style="margin-top:16px">
  <sl-card id="authCard">
    <div slot="header"><b>دخول</b></div>
    <div class="grid">
      <sl-input id="email" label="البريد الإلكتروني"></sl-input>
      <sl-input id="password" type="password" label="كلمة المرور"></sl-input>
      <div class="row">
        <sl-button id="login" variant="primary">تسجيل الدخول</sl-button>
        <sl-button id="signup" variant="default">إنشاء حساب</sl-button>
      </div>
      <div class="muted">بعد الدخول، أكمل الملف واختر الدور.</div>
    </div>
  </sl-card>

  <sl-card id="profileCard" class="hidden">
    <div slot="header"><b>ملفي</b></div>
    <div class="grid">
      <sl-input id="pfName" label="الاسم"></sl-input>
      <sl-input id="pfPhone" label="الهاتف"></sl-input>
      <sl-select id="pfRole" label="الدور">
        <sl-option value="sales">سيلز</sl-option>
        <sl-option value="install">تركيب</sl-option>
      </sl-select>
      <sl-button id="saveProfile" variant="primary">حفظ الملف</sl-button>
    </div>
  </sl-card>

  <sl-card id="meCard" class="hidden">
    <div slot="header"><b>لوحة التحكم</b></div>
    <div class="grid">
      <div class="row"><span class="pill" id="meRole">—</span><span class="pill" id="meName">—</span><a id="mePhone" class="pill" href="#">—</a></div>
      <sl-button id="switchMeetings" variant="default"><i class="bi bi-people"></i>&nbsp;الاجتماعات</sl-button>
      <sl-button id="switchOrders" variant="default"><i class="bi bi-receipt"></i>&nbsp;الطلبات (بانتظار القرار)</sl-button>
      <sl-button id="switchPayments" variant="default"><i class="bi bi-cash-coin"></i>&nbsp;الدفعات</sl-button>
      <sl-button id="switchInstall" variant="default"><i class="bi bi-tools"></i>&nbsp;التركيب</sl-button>
      <sl-button id="switchCompleted" variant="default"><i class="bi bi-check2-circle"></i>&nbsp;المشاريع المنفذة</sl-button>
      <sl-button id="switchOnHold" variant="default"><i class="bi bi-pause-circle"></i>&nbsp;الطلبات المعلقة</sl-button>
    </div>
  </sl-card>

  <sl-card id="qaCard" class="hidden">
    <div slot="header"><b>أوامر سريعة</b></div>
    <div class="grid">
      <sl-button id="newMeeting" outline variant="primary"><i class="bi bi-calendar-plus"></i>&nbsp;اجتماع جديد</sl-button>
      <sl-button id="openWizardEmpty" outline variant="primary"><i class="bi bi-rulers"></i>&nbsp;نموذج القياس</sl-button>
    </div>
  </sl-card>
</div>

<!-- Panels -->
<div class="container" style="margin-top:16px">
  <sl-card id="panelMeetings" class="hidden">
    <div class="row" style="justify-content:space-between">
      <h3 style="margin:0">قائمة الاجتماعات</h3>
      <sl-button id="addMeetingBtn" pill variant="primary">اجتماع جديد</sl-button>
    </div>
    <div id="meetingsList" class="grid"></div>
  </sl-card>

  <sl-card id="panelOrders" class="hidden">
    <h3 style="margin:0">الطلبات — بانتظار القرار</h3>
    <div class="muted">اختر <b>تم</b> لنقل الطلب إلى <b>التركيب والدفعات</b>، أو <b>لم يتم</b> لنقله إلى <b>الطلبات المعلقة</b>. بعد الاختيار يختفي من هذه القائمة تلقائياً.</div>
    <div id="ordersList" class="grid" style="margin-top:10px"></div>
  </sl-card>

  <sl-card id="panelPayments" class="hidden">
    <h3 style="margin:0">الدفعات</h3>
    <div class="muted">تظهر هنا الطلبات المؤكدة (جاهزة للتركيب). لكل طلب: الإجمالي، المدفوع، المتبقي، رابط الكوتيشن، وطباعة فاتورة للمتبقي.</div>
    <div id="paymentsList" class="grid" style="margin-top:10px"></div>
  </sl-card>

  <sl-card id="panelInstall" class="hidden">
    <h3 style="margin:0">التركيب</h3>
    <div id="installList" class="grid" style="margin-top:10px"></div>
    <div id="installEmpty" class="empty hidden">لا يوجد طلبات مجدولة للتركيب حالياً.</div>
  </sl-card>

  <sl-card id="panelCompleted" class="hidden">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h3 style="margin:0">المشاريع المنفذة</h3>
      <div class="row" style="gap:8px">
        <sl-input id="completedSince" type="date" label="طباعة من تاريخ"></sl-input>
        <sl-button id="completedPrintBtn" outline><i class="bi bi-printer"></i>&nbsp;طباعة تقرير مبسّط</sl-button>
      </div>
    </div>
    <div id="completedList" class="grid" style="margin-top:10px"></div>
    <div id="completedEmpty" class="empty hidden">لا يوجد مشاريع منفذة بعد.</div>
  </sl-card>

  <sl-card id="panelOnHold" class="hidden">
    <h3 style="margin:0">الطلبات المعلقة</h3>
    <div id="holdList" class="grid" style="margin-top:10px"></div>
    <div id="holdEmpty" class="empty hidden">لا يوجد طلبات معلّقة.</div>
  </sl-card>
</div>

<!-- Settings -->
<sl-dialog id="dlgSettings" label="إعدادات Firebase" style="--width:680px">
  <div class="grid">
    <sl-input id="fb_apiKey" label="apiKey"></sl-input>
    <sl-input id="fb_authDomain" label="authDomain"></sl-input>
    <sl-input id="fb_projectId" label="projectId"></sl-input>
    <sl-input id="fb_storageBucket" label="storageBucket"></sl-input>
    <sl-input id="fb_messagingSenderId" label="messagingSenderId"></sl-input>
    <sl-input id="fb_appId" label="appId"></sl-input>
  </div>
  <sl-button slot="footer" id="resetSettings" variant="default">مسح</sl-button>
  <sl-button slot="footer" id="saveSettings" variant="primary">حفظ</sl-button>
</sl-dialog>

<!-- Danger -->
<sl-dialog id="dlgDanger" label="🛑 الحذف الشامل" style="--width:720px">
  <div class="soft" style="margin-bottom:10px">تحذير: لا رجعة في عمليات الحذف. ستُحذف الملفات من التخزين إن أمكن.</div>
  <div class="grid" style="grid-template-columns:1fr 1fr">
    <sl-card><div slot="header"><b>حذف حسب النوع</b></div>
      <div class="grid">
        <sl-button data-action="wipe-meetings" outline variant="danger">حذف كل الاجتماعات</sl-button>
        <sl-button data-action="wipe-orders" outline variant="danger">حذف كل الطلبات</sl-button>
        <sl-button data-action="wipe-completed" outline variant="danger">حذف المشاريع المنفذة</sl-button>
      </div>
    </sl-card>
    <sl-card><div slot="header"><b>حذف كُلّي</b></div>
      <div class="grid">
        <sl-input id="wipeConfirm" label='اكتب: حذف الكل'></sl-input>
        <sl-button data-action="wipe-all" variant="danger">حذف الكل</sl-button>
      </div>
    </sl-card>
  </div>
  <sl-button slot="footer" class="no-print" onclick="document.getElementById('dlgDanger').hide()">إغلاق</sl-button>
</sl-dialog>

<!-- Meeting Dialog -->
<sl-dialog id="dlgMeeting" label="اجتماع جديد" style="--width:720px">
  <div class="grid">
    <sl-input id="mt_name" label="اسم العميل"></sl-input>
    <sl-input id="mt_phone" label="رقم العميل"></sl-input>
    <sl-input id="mt_request" label="المطلوب"></sl-input>
    <sl-input id="mt_link" label="رابط الموقع (خرائط)"></sl-input>
    <sl-input id="mt_when" type="datetime-local" label="موعد الاجتماع"></sl-input>
    <sl-textarea id="mt_address" label="العنوان"></sl-textarea>
  </div>
  <div slot="footer" class="row">
    <sl-button id="saveMeeting" variant="primary">حفظ</sl-button>
    <sl-button onclick="document.getElementById('dlgMeeting').hide()">إلغاء</sl-button>
  </div>
</sl-dialog>

<!-- Wizard -->
<sl-dialog id="dlgWizard" label="نموذج القياس والكوتيشن" style="--width:1000px;--body-spacing:0 0 12px 0">
  <div class="soft">الخطوات: بيانات العميل → القياسات → القماش → الملخص</div>
  <div id="wz-client">
    <h3 style="margin:6px 0">بيانات العميل</h3>
    <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr))">
      <sl-input id="wz_name" label="الاسم"></sl-input>
      <sl-input id="wz_phone" label="الهاتف"></sl-input>
      <sl-input id="wz_date" type="date" label="التاريخ"></sl-input>
    </div>
    <sl-textarea id="wz_address" label="العنوان"></sl-textarea>
    <div class="row" style="justify-content:flex-end;margin-top:8px">
      <sl-button id="wz_client_next" variant="primary">التالي</sl-button>
    </div>
  </div>

  <div id="wz-measure" class="hidden">
    <h3 style="margin:6px 0">قياسات النوافذ</h3>
    <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(180px,1fr))">
      <sl-input id="wz_loc" label="الموقع"></sl-input>
      <sl-input id="wz_w" type="number" label="العرض (سم)"></sl-input>
      <sl-input id="wz_h" type="number" label="الارتفاع (سم)"></sl-input>
    </div>
    <div class="row" style="margin-top:8px;align-items:flex-start">
      <label class="pill" style="cursor:pointer">
        <input type="file" id="wz_windowPhoto" accept="image/*" capture="environment" style="display:none">
        <i class="bi bi-camera"></i>&nbsp;صورة النافذة
      </label>
      <div id="wz_windowPreview"></div>
    </div>
    <div class="row" style="gap:8px;margin-top:8px">
      <sl-button id="wz_add_measure" variant="primary">💾 حفظ القياس</sl-button>
      <sl-button id="wz_to_fabrics" variant="success">🎨 اختيار القماش</sl-button>
    </div>
    <div id="wz_measureList" style="margin-top:8px"></div>
  </div>

  <div id="wz-fabrics" class="hidden">
    <h3 style="margin:6px 0">اختيار القماش</h3>
    <div class="muted" id="wz_fabricHeader"></div>
    <div id="wz_fabricButtons" class="row" style="flex-wrap:wrap"></div>
    <input type="hidden" id="wz_fabric_val"/>
    <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr));margin-top:6px">
      <sl-input id="wz_codeChiffon" label="كود الشيفون"></sl-input>
      <sl-input id="wz_codeBlackout" label="كود البلاك/مخمل"></sl-input>
    </div>
    <div class="row" style="margin-top:6px">
      <label class="pill" style="cursor:pointer">
        <input type="file" id="wz_photoChiffon" accept="image/*" capture="environment" style="display:none">
        <i class="bi bi-image"></i>&nbsp;صورة قماش الشيفون
      </label>
      <label class="pill" style="cursor:pointer">
        <input type="file" id="wz_photoBlackout" accept="image/*" capture="environment" style="display:none">
        <i class="bi bi-image"></i>&nbsp;صورة قماش البلاك/مخمل
      </label>
    </div>
    <div class="row" style="justify-content:space-between;margin-top:8px">
      <sl-button id="wz_prevFabric">⬅️ السابق</sl-button>
      <div class="row">
        <sl-button id="wz_nextFabric" variant="primary">➡️ التالي</sl-button>
        <sl-button id="wz_finishFabrics" variant="success">✅ الذهاب للملخص</sl-button>
      </div>
    </div>
  </div>

  <div id="wz-summary" class="hidden">
    <h3 style="margin:6px 0">ملخص الطلب</h3>
    <div id="wz_summaryContent"></div>
    <sl-textarea id="wz_notes" label="ملاحظات" rows="3"></sl-textarea>
    <div class="total-box" style="margin-top:8px">
      <div>الإجمالي قبل الضريبة: <b><span id="wz_sumPrice">0</span></b> درهم</div>
      <div>الضريبة (5%): <b><span id="wz_sumVAT">0</span></b> درهم</div>
      <div><b>الإجمالي النهائي: <span id="wz_sumTotal">0</span> درهم</b></div>
      <div>الخصم: <input id="wz_discount" type="number" placeholder="0" style="width:140px;border:1px solid var(--border);border-radius:8px;padding:6px"> درهم</div>
      <div><b>بعد الخصم: <span id="wz_sumAfterDiscount">0</span> درهم</b></div>
    </div>
    <div class="row" style="justify-content:space-between;margin-top:8px;flex-wrap:wrap;gap:8px">
      <div class="row">
        <sl-button id="wz_btnPDF" variant="primary"><i class="bi bi-filetype-pdf"></i>&nbsp;توليد PDF (تحميل فوري)</sl-button>
        <sl-button id="wz_btnSave" variant="success">💾 حفظ الطلب</sl-button>
        <sl-button id="wz_btnWA" outline>إرسال واتساب</sl-button>
      </div>
      <sl-button id="wz_btnClose">إغلاق</sl-button>
    </div>
  </div>
</sl-dialog>

<!-- Order Detail + Print -->
<sl-dialog id="dlgOrderDetail" label="تفاصيل الطلب" style="--width:1000px;--body-spacing:0 0 12px 0">
  <div id="detailContent" class="soft"></div>
  <div slot="footer" class="row">
    <sl-button id="btnPrint" variant="primary"><i class="bi bi-printer"></i>&nbsp;طباعة الملخص فقط</sl-button>
    <sl-button onclick="document.getElementById('dlgOrderDetail').hide()">إغلاق</sl-button>
  </div>
</sl-dialog>


<sl-dialog id="dlgCompletedDetail" label="تفاصيل مشروع مُنفّذ" style="--width:1000px;--body-spacing:0 0 12px 0">
  <div id="completedDetailContent" class="soft"></div>
  <div slot="footer" class="row" style="justify-content:space-between;flex-wrap:wrap;gap:8px">
    <div class="row">
      <sl-input id="completedPrintSince" type="date" label="طباعة من تاريخ"></sl-input>
      <sl-button id="btnPrintCompleted" variant="primary"><i class="bi bi-printer"></i>&nbsp;طباعة ملخص مبسّط</sl-button>
    </div>
    <sl-button onclick="document.getElementById('dlgCompletedDetail').hide()">إغلاق</sl-button>
  </div>
</sl-dialog>


<div id="printScope" class="hidden"></div>

<sl-alert id="toast" variant="success" duration="2400" closable style="position:fixed;bottom:16px;right:16px;z-index:3000">
  <sl-icon slot="icon" name="check2-circle"></sl-icon>
  <strong id="toastMsg">تم</strong>
</sl-alert>

<script>
// Seed Firebase config (can be replaced from الإعدادات)
(function(){
  try{
    const seed={apiKey:"AIzaSyAziq7S7bCak_mtKgcLAbsepq3a1yn3NuE",authDomain:"curtain-sales.firebaseapp.com",projectId:"curtain-sales",storageBucket:"curtain-sales.appspot.com",messagingSenderId:"11032657718",appId:"1:11032657718:web:5e8a8a7448172bd82a7d97"};
    if(!localStorage.getItem('fb_cfg_v1')) localStorage.setItem('fb_cfg_v1',JSON.stringify(seed));
  }catch(e){
    // /*GUARD_FINAL_RESET*/ safety reset
    saveOnceGuard=false; $('#wz_btnSave').removeAttribute('disabled');console.warn(e)}
})();
</script>

<script type="module">
const $ = s=>document.querySelector(s);
const $$ = s=>Array.from(document.querySelectorAll(s));
const show = el=>el.classList.remove('hidden');
const hide = el=>el.classList.add('hidden');
const toast = (msg,variant='success')=>{const t=$('#toast');t.setAttribute('variant',variant);$('#toastMsg').textContent=msg;t.show();setTimeout(()=>t.hide(),2200)};
const cfgKey='fb_cfg_v1';
const cfg={get(){try{return JSON.parse(localStorage.getItem(cfgKey)||'{}')}catch(_){return{}}},set(o){localStorage.setItem(cfgKey,JSON.stringify(o))}};

let app,auth,db,storage;
let meetingContext=null;
let curtains=[]; let curFabricIndex=0;
let windowPhotoData=null,chiffonPhotoData=null,blackoutPhotoData=null;
const MAX_W=1400, MAX_H=1000, JPEG_Q=0.78;

async function fileToDataURL(file,maxW=MAX_W,maxH=MAX_H,q=JPEG_Q){
  const img=await new Promise((res,rej)=>{const fr=new FileReader();fr.onload=()=>{const im=new Image();im.onload=()=>res(im);im.onerror=rej;im.src=fr.result};fr.onerror=rej;fr.readAsDataURL(file)});
  const c=document.createElement('canvas');const ctx=c.getContext('2d');
  const ratio=Math.min(maxW/img.width,maxH/img.height,1);const w=Math.round(img.width*ratio),h=Math.round(img.height*ratio);
  c.width=w;c.height=h;ctx.drawImage(img,0,0,w,h);return c.toDataURL('image/jpeg',q);
}

function fabricOptions(){
  return [
    {label:"Chiffon - 70 AED / شيفون", price:70},
    {label:"Chiffon Wavy - 90 AED / شيفون ويفي", price:90},
    {label:"Velvet - 90 AED / مخمل", price:90},
    {label:"Velvet Wavy - 100 AED / مخمل ويفي", price:100},
    {label:"Velvet with Chiffon - 110 AED / مخمل مع شيفون", price:110},
    {label:"Velvet Wavy with Chiffon - 130 AED / مخمل ويفي مع شيفون", price:130},
    {label:"Velvet with Chiffon Wavy - 120 AED / مخمل مع شيفون ويفي", price:120},
    {label:"Velvet Wavy with Chiffon Wavy - 150 AED / مخمل ويفي مع شيفون ويفي", price:150},
    {label:"Blackout - 120 AED / بلاك اوت", price:120},
    {label:"Blackout Wavy - 135 AED / بلاك اوت ويفي", price:135},
    {label:"Blackout with Chiffon - 150 AED / بلاك اوت مع شيفون", price:150},
    {label:"Blackout Wavy with Chiffon - 185 AED / بلاك اوت ويفي مع شيفون", price:185},
    {label:"Blackout with Chiffon Wavy - 170 AED / بلاك اوت مع شيفون ويفي", price:170},
    {label:"Blackout Wavy with Chiffon Wavy - 200 AED / بلاك اوت ويفي مع شيفون ويفي", price:200},
    {label:"Roll-up - 120 AED / رول اب", price:120},
  ];
}

function buildFabricButtons(){
  const box=$('#wz_fabricButtons'); box.innerHTML='';
  fabricOptions().forEach(opt=>{
    const b=document.createElement('button'); b.type='button';
    b.className='pill'; b.style.cursor='pointer';
    b.textContent=opt.label; b.dataset.price=opt.price; b.dataset.label=opt.label;
    b.onclick=()=>{ $$('#wz_fabricButtons .pill').forEach(x=>x.style.background='#fff'); b.style.background='#ffe7a0';
      $('#wz_fabric_val').value=String(opt.price); $('#wz_fabric_val').setAttribute('data-label',opt.label);
      if(typeof curFabricIndex==='number' && Array.isArray(curtains) && curtains[curFabricIndex]){
        curtains[curFabricIndex].unit = opt.price;
        curtains[curFabricIndex].fabric = opt.label;
      }
    };
    box.appendChild(b);
  });
}

function calcCurtain(c){
  const w=parseFloat(c.width||0), h=parseFloat(c.height||0), unit=parseFloat(c.unit||0);
  const area=(w/100)*(h/100); const price=area*unit; const vat=price*0.05; const total=price+vat;
  return {price,vat,total};
}

function renderMeasureList(){
  const cont=$('#wz_measureList');
  if(!curtains.length){cont.innerHTML='';return}
  let html='<h4 style="margin:0 0 6px;text-align:center">القياسات المُضافة</h4>';
  curtains.forEach((c,i)=>{
    html+=`<div class="cur-sum"><b>ستارة ${i+1} — ${c.location||'-'}</b>
      <div>العرض: ${c.width} سم — الارتفاع: ${c.height} سم</div>
      ${c.windowPhoto?`<img class="thumb" src="${c.windowPhoto}">`:``}</div>`;
  });
  cont.innerHTML=html;
}

function loadFabricForm(){
  const c=curtains[curFabricIndex];
  $('#wz_fabricHeader').textContent=`ستارة ${curFabricIndex+1} من ${curtains.length} — ${c.location}`;
  $$('#wz_fabricButtons .pill').forEach(x=>x.style.background='#fff');
  if(c.fabric){
    const btn=[...$('#wz_fabricButtons').children].find(x=>x.dataset.label===c.fabric);
    if(btn){ btn.style.background='#ffe7a0'; $('#wz_fabric_val').value=btn.dataset.price; $('#wz_fabric_val').setAttribute('data-label',btn.dataset.label); }
  }else{ $('#wz_fabric_val').value=''; $('#wz_fabric_val').removeAttribute('data-label'); }
  $('#wz_codeChiffon').value=c.codeChiffon||'';
  $('#wz_codeBlackout').value=c.codeBlackout||'';
  chiffonPhotoData=c.chiffonPhoto||null; blackoutPhotoData=c.blackoutPhoto||null;
}

function showSummary(){
  const s=$('#wz_summaryContent'); let html=''; let sumP=0,sumV=0,sumT=0;
  html+=`<div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr))">
    <div><b>الاسم:</b> ${$('#wz_name').value||''}</div>
    <div><b>الهاتف:</b> ${$('#wz_phone').value||''}</div>
    <div><b>التاريخ:</b> ${$('#wz_date').value||''}</div></div>
    <div><b>العنوان:</b> ${$('#wz_address').value||''}</div><div class="hr"></div>`;
  curtains.forEach((c,i)=>{
    const k=calcCurtain(c);
    c.price=k.price.toFixed(2); c.vat=k.vat.toFixed(2); c.total=k.total.toFixed(2);
    sumP+=k.price; sumV+=k.vat; sumT+=k.total;
    html+=`<div class="cur-sum"><h4 style="margin:0 0 6px">ستارة ${i+1} — ${c.location}</h4>
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(180px,1fr))">
        <div><b>العرض:</b> ${c.width} سم</div><div><b>الارتفاع:</b> ${c.height} سم</div><div><b>القماش:</b> ${c.fabric||'—'}</div></div>
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(180px,1fr))">
        <div><b>كود الشيفون:</b> ${c.codeChiffon||'—'}</div><div><b>كود البلاك/مخمل:</b> ${c.codeBlackout||'—'}</div></div>
      <div><b>السعر:</b> ${c.price} + VAT ${c.vat} = ${c.total} درهم</div>
      ${c.windowPhoto?`<img class="thumb" src="${c.windowPhoto}">`:``}
      ${c.chiffonPhoto?`<img class="thumb" src="${c.chiffonPhoto}">`:``}
      ${c.blackoutPhoto?`<img class="thumb" src="${c.blackoutPhoto}">`:``}
    </div>`;
  });
  $('#wz_sumPrice').textContent=sumP.toFixed(2);
  $('#wz_sumVAT').textContent=sumV.toFixed(2);
  $('#wz_sumTotal').textContent=sumT.toFixed(2);
  $('#wz_sumAfterDiscount').textContent=sumT.toFixed(2);
  s.innerHTML=html;
  hide($('#wz-measure')); hide($('#wz-fabrics')); hide($('#wz-client')); show($('#wz-summary'));
}

function summaryLines(){
  let lines=[];
  lines.push(`العميل: ${$('#wz_name').value}

/* ==== PATCH: Auto-delete meeting after first measurement save ==== */
(function(){
  try{
    const btn = document.querySelector('#wz_add_measure');
    if(btn){
      btn.addEventListener('click', async function _autoDeleteMeetingOnce(){
        try{
          if(window.meetingContext && meetingContext.id){
            const id = meetingContext.id;
            await window.FB.deleteDoc(window.FB.doc(db, 'meetings', id));
            // Optimistic UI: remove meeting card if visible
            try{
              const mbtn = document.querySelector(`[data-id="${id}"]`);
              const card = mbtn ? mbtn.closest('sl-card') : null;
              if(card) card.remove();
            }catch(_){}
            try{ toast('تم حذف الاجتماع تلقائيًا بعد حفظ القياس'); }catch(_){}
            meetingContext.id = null; // prevent later double-delete
          }
        }catch(e){
          try{ console.warn('auto-delete meeting failed', e && (e.message||e.code||e)); }catch(_){}
        }
      }, { once:true });
    }
  }catch(e){
    try{ console.warn('auto-delete patch init error', e && (e.message||e.code||e)); }catch(_){}
  }
})();
/* ==== END PATCH ==== */

`);
  lines.push(`الهاتف: ${$('#wz_phone').value}`);
  lines.push(`العنوان: ${$('#wz_address').value}`);
  lines.push(`التاريخ: ${$('#wz_date').value}`);
  curtains.forEach((c,i)=>lines.push(`ستارة ${i+1} — ${c.location} — ${c.width}x${c.height} — ${c.fabric||'-'} — ${c.total||0} درهم`));
  lines.push(`الإجمالي: ${$('#wz_sumTotal').textContent} درهم`);
  const d=parseFloat($('#wz_discount').value)||0; if(d>0) lines.push(`خصم: ${d} — بعد الخصم: ${$('#wz_sumAfterDiscount').textContent} درهم`);
  return lines.join('\\n');
}

// Firebase helpers
async function uploadDataURL(path,dataURL){
  const {ref,uploadString,getDownloadURL} = window.FB;
  const r=ref(storage,path); await uploadString(r,dataURL,'data_url'); return await getDownloadURL(r);
}
async function uploadBlob(path,blob){
  const {ref,uploadBytes,getDownloadURL} = window.FB;
  const r=ref(storage,path); await uploadBytes(r,blob,{contentType:'application/pdf'}); return await getDownloadURL(r);
}
async function copyUrlToPath(url,dest){
  const resp=await fetch(url); const blob=await resp.blob(); return await uploadBlob(dest,blob);
}
async function deleteFolder(path){
  try{
    const {ref,listAll,deleteObject} = window.FB;
    async function _del(r){const {items,prefixes}=await listAll(r); for(const it of items){try{await deleteObject(it)}catch(e){}} for(const p of prefixes){await _del(p)}}
    const root=ref(storage,path.endsWith('/')?path:path+'/'); await _del(root);
  }catch(e){
    // /*GUARD_FINAL_RESET*/ safety reset
    saveOnceGuard=false; $('#wz_btnSave').removeAttribute('disabled');console.warn('deleteFolder fallback',e)}
}

// PDFs
function makeQuotationPDF(order){
  const {jsPDF}=window.jspdf; const doc=new jsPDF('p','pt','a4');
  doc.setFont('helvetica','bold'); doc.setFontSize(16);
  doc.text('Victorian Art Interior Decoration L.L.C — Curtains Quotation',40,40);
  doc.setFont('helvetica','normal'); doc.setFontSize(10);
  doc.text(`Client: ${order.name}    Phone: ${order.phone}`,40,60);
  doc.text(`Address: ${order.address||'-'}`,40,74);
  doc.text(`Date: ${order.date||''}`,40,88);
  const rows=(order.curtains||[]).map((c,i)=>[i+1,c.location||'',`${c.width} x ${c.height} cm`,(c.fabric||'').split(' / ')[0],Number(c.price||0).toFixed(2),Number(c.vat||0).toFixed(2),Number(c.total||0).toFixed(2)]);
  doc.autoTable({startY:110,head:[["#","Location","Size","Fabric","Price","VAT","Total"]],body:rows,styles:{fontSize:9},headStyles:{fillColor:[11,105,255]}});
  let y=doc.lastAutoTable.finalY+16;
  doc.setFontSize(11); doc.text(`Subtotal: ${Number(order.sumPrice||0).toFixed(2)} AED`,40,y); y+=16;
  doc.text(`VAT (5%): ${Number(order.sumVAT||0).toFixed(2)} AED`,40,y); y+=16;
  doc.setFont('helvetica','bold'); doc.text(`Grand Total: ${Number(order.sumTotal||0).toFixed(2)} AED`,40,y); y+=16;
  doc.setFont('helvetica','normal');
  if(Number(order.discount||0)>0){ doc.text(`Discount: ${Number(order.discount||0).toFixed(2)} AED`,40,y); y+=16; doc.text(`After Discount: ${Number(order.afterDiscount||order.sumTotal||0).toFixed(2)} AED`,40,y); y+=16; }
  if(order.notes){ y+=6; doc.setFontSize(10); doc.text(`Notes: ${order.notes}`,40,y,{maxWidth:520}); }
  y=800; doc.setFontSize(9); doc.text('Payment Terms: 50% advance, 50% upon installation.',40,y);
  return doc;
}

function makeInvoicePDF(order){
  const {jsPDF}=window.jspdf; const doc=new jsPDF('p','pt','a4');
  doc.setFont('helvetica','bold'); doc.setFontSize(16);
  doc.text('Victorian Art — Payment Invoice',40,40);
  doc.setFont('helvetica','normal'); doc.setFontSize(10);
  doc.text(`Client: ${order.name}    Phone: ${order.phone}`,40,60);
  doc.text(`Address: ${order.address||'-'}`,40,74);
  doc.text(`Order Date: ${order.date||''}`,40,88);
  const due=Math.max(Number(order.total||0)-Number(order.paid||0),0);
  doc.autoTable({startY:110, head:[["Total (AED)","Paid (AED)","Balance (AED)"]],
    body:[[Number(order.total||0).toFixed(2),Number(order.paid||0).toFixed(2),due.toFixed(2)]],
    styles:{fontSize:11}, headStyles:{fillColor:[181,142,0]}});
  let y=doc.lastAutoTable.finalY+30; doc.setFontSize(12);
  doc.text('Please pay the remaining balance to proceed.',40,y);
  y+=80; doc.text('Customer Signature: ____________________________',40,y);
  return doc;
}

async function makeDeliveryNotePDF(order, photos=[]){
  const {jsPDF}=window.jspdf; const doc=new jsPDF('p','pt','a4');
  doc.setFont('helvetica','bold'); doc.setFontSize(16);
  doc.text('Victorian Art — Delivery Note',40,40);
  doc.setFont('helvetica','normal'); doc.setFontSize(10);
  doc.text(`Client: ${order.name}    Phone: ${order.phone}`,40,60);
  doc.text(`Address: ${order.address||'-'}`,40,74);
  doc.text(`Completed On: ${(new Date()).toLocaleDateString()}`,40,88);
  const rows=(order.curtains||[]).map((c,i)=>[i+1,c.location||'',`${c.width} x ${c.height} cm`,(c.fabric||'').split(' / ')[0]]);
  doc.autoTable({startY:110, head:[["#","Location","Size","Fabric"]], body:rows, styles:{fontSize:9}, headStyles:{fillColor:[16,185,129]}});
  let y=doc.lastAutoTable.finalY+16; doc.setFontSize(11); doc.text('Execution Photos:',40,y); y+=10;
  // add final photos only
  for(const p of photos){
    try{
      const img=await fetch(p).then(r=>r.blob()).then(b=>new Promise(res=>{const fr=new FileReader();fr.onload=()=>res(fr.result);fr.readAsDataURL(b)}));
      const w=220,h=150;
      if(y>730){ doc.addPage(); y=50; }
      doc.addImage(img,'JPEG',40,y,w,h); y+=h+10;
    }catch(_){}
  }
  y=770; doc.setFontSize(12); doc.text('Client Signature: ____________________________',40,y);
  return doc;
}


function formatDateTs(ts){
  try{
    if(!ts) return '';
    if(typeof ts === 'string' || typeof ts === 'number') return new Date(ts).toLocaleString();
    if(ts.seconds) return new Date(ts.seconds*1000).toLocaleString();
    return '';
  }catch(_){ return ''; }
}
function paymentHistoryHtml(p){
  const arr = Array.isArray(p.paymentsHistory) ? p.paymentsHistory : [];
  if(!arr.length) return '<div class="muted">لا يوجد سجل دفعات</div>';
  const rows = arr.map((it,i)=>`<div class="row" style="gap:8px"><div class="pill">#${i+1}</div><div class="pill">${Number(it.amount||0).toFixed(2)} AED</div><div class="pill">${formatDateTs(it.at)}</div></div>`).join('');
  return `<div class="grid" style="gap:6px">${rows}</div>`;
}
function allPhotosHtml(p){
  const ms = (p.curtains||[]).map(c=>[c.windowPhoto,c.chiffonPhoto,c.blackoutPhoto].filter(Boolean)).flat();
  const finals = p.finalPhotos||[];
  const urls = [...ms, ...finals];
  if(!urls.length) return '<div class="muted">لا يوجد صور</div>';
  return `<div class="gallery">${urls.map(u=>`<img class='thumb' src="${u}">`).join('')}</div>`;
}
function openCompletedDetail(id, p){
  const body = `
    <h3 style="margin:0 0 6px">ملخص المشروع — ${p.name||''}</h3>
    <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(200px,1fr))">
      <div><b>الهاتف:</b> ${p.phone||''}</div>
      <div><b>العنوان:</b> ${p.address||''}</div>
      <div><b>تاريخ الإكمال:</b> ${formatDateTs(p.completedAt)}</div>
    </div>
    <div class="hr"></div>
    <h4>العناصر</h4>
    ${fullSummaryNoMoney(p)}
    <div class="hr"></div>
    <h4>سجل الدفعات</h4>
    ${paymentHistoryHtml(p)}
    <div class="hr"></div>
    <h4>الصور</h4>
    ${allPhotosHtml(p)}
  `;
  const cont = document.getElementById('completedDetailContent');
  if(cont){ cont.innerHTML = body; }
  document.getElementById('dlgCompletedDetail').show();
  const btn = document.getElementById('btnPrintCompleted');
  if(btn){ btn.onclick = ()=>{ const since=document.getElementById('completedPrintSince')?.value; printCompletedSingle(p, since); }; }
}
function printCompletedSingle(p, sinceDate){
  const since = sinceDate ? new Date(sinceDate) : null;
  const hist = (Array.isArray(p.paymentsHistory)?p.paymentsHistory:[]).filter(it=>{
    if(!since) return true;
    const t = it?.at?.seconds ? new Date(it.at.seconds*1000) : (it.at? new Date(it.at): null);
    return t ? (t >= since) : true;
  });
  const histHtml = hist.length ? (`<h4>سجل الدفعات (مبسّط)</h4>` + hist.map((it,i)=>`<div>#${i+1} — ${Number(it.amount||0).toFixed(2)} AED — ${formatDateTs(it.at)}</div>`).join('')) : '';
  const photos = (p.finalPhotos||[]);
  const bodyHtml = `<div id="printBody">
      <h3>مشروع مُنفّذ — ${p.name||''}</h3>
      <div><b>العنوان:</b> ${p.address||''}</div>
      <div><b>تاريخ الإكمال:</b> ${formatDateTs(p.completedAt)}</div>
      <div class="hr"></div>
      <h4>عناصر الطلب (بدون أسعار)</h4>
      ${fullSummaryNoMoney(p)}
      ${histHtml}
      <div class="hr"></div>
      <h4>صور التنفيذ</h4>
      <div>${photos.map(u=>`<img src="${u}" style="max-width:8cm;height:auto;margin:4px;display:inline-block;border:1px solid #eee;border-radius:6px">`).join('')}</div>
    </div>`;
  let hiddenScope = document.getElementById('printScope');
  if(!hiddenScope){ hiddenScope = document.createElement('div'); hiddenScope.id='printScope'; document.body.appendChild(hiddenScope); }
  hiddenScope.innerHTML = bodyHtml;
  const clone = document.getElementById('printBody').cloneNode(true); clone.id='printScope'; clone.classList.remove('hidden');
  hiddenScope.replaceWith(clone);
  window.print();
  document.body.appendChild(hiddenScope);
}
function printCompletedSummary(sinceDate){
  const since = sinceDate ? new Date(sinceDate) : null;
  const items = (window.__completedCache||[]).filter(p=>{
    if(!since) return true;
    const t = p.completedAt?.seconds ? new Date(p.completedAt.seconds*1000) : (p.completedAt? new Date(p.completedAt): null);
    return t ? (t >= since) : true;
  });
  const rows = items.map(p=>`<tr><td>${p.name||''}</td><td>${p.address||''}</td><td>${formatDateTs(p.completedAt)}</td><td>${p.phone||''}</td></tr>`).join('');
  const bodyHtml = `<div id="printBody">
    <h3>تقرير المشاريع المنفّذة (مبسّط)</h3>
    ${since?`<div class="muted">منذ: ${since.toLocaleDateString()}</div>`:''}
    <table border="1" cellspacing="0" cellpadding="6" style="width:100%;border-collapse:collapse">
      <thead><tr><th>العميل</th><th>العنوان</th><th>تاريخ الإكمال</th><th>الهاتف</th></tr></thead>
      <tbody>${rows||'<tr><td colspan="4">لا يوجد عناصر</td></tr>'}</tbody>
    </table>
  </div>`;
  let hiddenScope = document.getElementById('printScope');
  if(!hiddenScope){ hiddenScope = document.createElement('div'); hiddenScope.id='printScope'; document.body.appendChild(hiddenScope); }
  hiddenScope.innerHTML = bodyHtml;
  const clone = document.getElementById('printBody').cloneNode(true); clone.id='printScope'; clone.classList.remove('hidden');
  hiddenScope.replaceWith(clone);
  window.print();
  document.body.appendChild(hiddenScope);
}


/* ==== PATCH: Quotation PDF with embedded photos (window & fabrics) ==== */
async function makeQuotationPDF_withPhotos(order){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p','pt','a4');

  // Header
  doc.setFont('helvetica','bold'); doc.setFontSize(16);
  doc.text('Victorian Art Interior Decoration L.L.C — Curtains Quotation', 40, 40);
  doc.setFont('helvetica','normal'); doc.setFontSize(10);
  doc.text(`Client: ${order.name||''}    Phone: ${order.phone||''}`, 40, 60);
  doc.text(`Address: ${order.address||'-'}`, 40, 74);
  doc.text(`Date: ${order.date||''}`, 40, 88);

  // Table
  const rows = (order.curtains||[]).map((c,i)=>[
    String(i+1),
    c.location||'—',
    `${c.width||0}×${c.height||0} cm`,
    c.fabric||'—',
    (c.total||0).toFixed(2)
  ]);

  if (doc.autoTable) {
    doc.autoTable({
      head: [['#','Location','Size','Fabric','Total (AED)']],
      body: rows,
      startY: 110,
      styles: { font: 'helvetica', fontSize: 10 },
      headStyles: { fillColor: [240,240,240] }
    });
  }
  let y = (doc.lastAutoTable && doc.lastAutoTable.finalY) ? (doc.lastAutoTable.finalY + 12) : 130;

  // Totals
  const fmt = n => (Number(n||0)).toFixed(2);
  doc.text(`Subtotal: ${fmt(order.sumPrice) } AED`, 40, y); y+=14;
  doc.text(`VAT (5%): ${fmt(order.sumVAT)} AED`, 40, y); y+=14;
  doc.text(`Discount: ${fmt(order.discount)} AED`, 40, y); y+=14;
  doc.setFont('helvetica','bold');
  doc.text(`Grand Total: ${fmt(order.afterDiscount)} AED`, 40, y); y+=18;
  doc.setFont('helvetica','normal');

  // Helper: URL -> dataURL
  async function toDataURL(u){
    try{
      if(!u) return null;
      if(String(u).startsWith('data:')) return u;
      const res = await fetch(u);
      const blob = await res.blob();
      const b64 = await new Promise((resolve, reject)=>{
        const fr = new FileReader();
        fr.onload = ()=>resolve(fr.result);
        fr.onerror = reject;
        fr.readAsDataURL(blob);
      });
      return b64;
    }catch(e){
      try{ console.warn('photo embed failed', e && (e.message||e.code||e)); }catch(_){}
      return null;
    }
  }

  // Photos block
  const maxW = 120, maxH = 90, gap = 10, pageBottom = 780;
  for(let i=0;i<(order.curtains||[]).length;i++){
    const c = order.curtains[i]||{};
    const imgs = [c.windowPhoto, c.chiffonPhoto, c.blackoutPhoto].filter(Boolean);
    if(!imgs.length) continue;
    if(y > pageBottom){ doc.addPage(); y = 40; }
    doc.setFont('helvetica','bold');
    doc.text(`Curtain ${i+1} — Photos`, 40, y); y += 8;
    doc.setFont('helvetica','normal');
    let x = 40;
    for(const u of imgs){
      const data = await toDataURL(u);
      if(!data) continue;
      if(x + maxW > 550){ // wrap to next row
        y += maxH + gap;
        x = 40;
        if(y > pageBottom){ doc.addPage(); y = 40; }
      }
      try{ doc.addImage(data, 'JPEG', x, y, maxW, maxH); }catch(_){}
      x += maxW + gap;
    }
    y += maxH + 14;
  }

  return doc;
}
/* ==== END PATCH ==== */

// reselect-file-on-click: allow re-choosing the same file by clearing input value on click
;['#wz_windowPhoto','#wz_photoChiffon','#wz_photoBlackout'].forEach(sel=>{
  const el = document.querySelector(sel);
  if(el){ el.addEventListener('click', ev=>{ try{ ev.target.value=''; }catch(e){} }); }
});

// Save order (single-shot even if user clicks multiple times)
let saveOnceGuard=false;
async function saveOrder({uploadPdf=false}){
  if(saveOnceGuard) return; saveOnceGuard=true; $('#wz_btnSave').setAttribute('disabled','true');
  const {collection,addDoc,serverTimestamp,doc:updateDocDoc,updateDoc,doc,getDoc,deleteDoc} = window.FB;
  let sumPrice=parseFloat($('#wz_sumPrice').textContent)||0;
  let sumVAT=parseFloat($('#wz_sumVAT').textContent)||0;
  let sumTotal=parseFloat($('#wz_sumTotal').textContent)||0;
  let discount=parseFloat($('#wz_discount').value)||0;
  let afterDiscount=(sumTotal-discount);
  const order={
    name:$('#wz_name').value.trim(),
    phone:$('#wz_phone').value.trim(),
    address:$('#wz_address').value.trim(),
    date:$('#wz_date').value,
    notes:$('#wz_notes').value.trim(),
    curtains, sumPrice,sumVAT,sumTotal,discount,afterDiscount,
    meetingId:meetingContext?.id||null, status:'pending', isConfirmed:false, total:afterDiscount, paid:0,
    quotationUrl:'', installDate:'', installTime:'',
    summaryText: summaryLines(), createdAt:serverTimestamp(), finalPhotos:[]
  };
  try{
    const ref=await addDoc(collection(db,'orders'),order); const orderId=ref.id;
    // upload curtain photos
    for(let i=0;i<curtains.length;i++){
      const c=curtains[i];
      if(c.windowPhoto)   c.windowPhoto   = await uploadDataURL(`orders/${orderId}/c${i+1}-window.jpg`,c.windowPhoto);
      if(c.chiffonPhoto)  c.chiffonPhoto  = await uploadDataURL(`orders/${orderId}/c${i+1}-chiffon.jpg`,c.chiffonPhoto);
      if(c.blackoutPhoto) c.blackoutPhoto = await uploadDataURL(`orders/${orderId}/c${i+1}-blackout.jpg`,c.blackoutPhoto);
    }
    await updateDoc(doc(db,'orders',orderId),{curtains});
    // PDF upload + download
    if(uploadPdf){
      try{
        const pdf = await makeQuotationPDF_withPhotos({...order,curtains});
        const fileName=`Quotation_${order.name||orderId}.pdf`;
        pdf.save(fileName); // تنزيل فوري
        const blob=pdf.output('blob');
        const url=await uploadBlob(`orders/${orderId}/quotation.pdf`,blob);
        await updateDoc(doc(db,'orders',orderId),{quotationUrl:url});
      }catch(e){
    // /*GUARD_FINAL_RESET*/ safety reset
    saveOnceGuard=false; $('#wz_btnSave').removeAttribute('disabled'); console.error(e); toast('تم تنزيل PDF محليًا. لم يُرفع للسحابة','warning'); }
    }
    // delete meeting automatically, convert to order
    if(order.meetingId){ try{ await deleteDoc(doc(db,'meetings',order.meetingId)); }catch(_){ } }
    toast('تم حفظ الطلب وتحويل الاجتماع إلى طلب');
    // Optimistic UI remove meeting card
    try{
      if(order.meetingId){
        const btn = document.querySelector(`[data-id="${order.meetingId}"]`);
        const card = btn ? btn.closest('sl-card') : null;
        if(card) card.remove();
      }
    }catch(_){}
    
    // hide measurements list after save
    $('#wz_measureList').innerHTML=''; hide($('#wz-measure')); hide($('#wz-fabrics')); hide($('#wz-summary')); $('#dlgWizard').hide();
    // reset guard after a brief delay to avoid double-add in snapshot churn
    setTimeout(()=>{ saveOnceGuard=false; $('#wz_btnSave').removeAttribute('disabled'); }, 1200);
    return orderId;
  }catch(e){
    // /*GUARD_FINAL_RESET*/ safety reset
    saveOnceGuard=false; $('#wz_btnSave').removeAttribute('disabled');
    saveOnceGuard=false; $('#wz_btnSave').removeAttribute('disabled');
    toast('تعذر الحفظ: '+(e.message||e.code),'danger');
  }
}

// Panels switcher
function openPanel(name){
  const map={meetings:'#panelMeetings',orders:'#panelOrders',payments:'#panelPayments',install:'#panelInstall',completed:'#panelCompleted',hold:'#panelOnHold'};
  Object.values(map).forEach(sel=>hide($(sel)));
  show($(map[name]));
}

// Order/Meeting render helpers
function curtainLines(o){
  return (o.curtains||[]).map((c,i)=>`<div class="muted">• ستارة ${i+1} (${c.location||'-'}) — ${c.width||'-'}×${c.height||'-'} سم — ${c.fabric||'—'} — ${c.total||0} درهم</div>`).join('');
}
function curtainMiniImgs(o){
  return (o.curtains||[]).map(c=>[c.windowPhoto,c.chiffonPhoto,c.blackoutPhoto].filter(Boolean)).flat().slice(0,4).map(u=>`<img src="${u}" style="width:64px;height:64px;object-fit:cover;border-radius:8px;border:1px solid #eee">`).join('');
}
function fullSummary(o){
  return (o.curtains||[]).map((c,i)=>`
    <div class="cur-sum">
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(160px,1fr))">
        <div><b>ستارة ${i+1}</b></div><div><b>الموقع:</b> ${c.location||'-'}</div><div><b>الأبعاد:</b> ${c.width||'-'} × ${c.height||'-'} سم</div>
      </div>
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(160px,1fr))">
        <div><b>القماش:</b> ${c.fabric||'—'}</div><div><b>كود الشيفون:</b> ${c.codeChiffon||'—'}</div><div><b>كود البلاك/مخمل:</b> ${c.codeBlackout||'—'}</div>
      </div>
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(160px,1fr))">
        <div><b>Price:</b> ${c.price||0}</div><div><b>VAT:</b> ${c.vat||0}</div><div><b>Total:</b> ${c.total||0}</div>
      </div>
      <div>${c.windowPhoto?`<img class="thumb" src="${c.windowPhoto}">`:``}${c.chiffonPhoto?`<img class="thumb" src="${c.chiffonPhoto}">`:``}${c.blackoutPhoto?`<img class="thumb" src="${c.blackoutPhoto}">`:``}</div>
    </div>`).join('');
}

function fullSummaryNoMoney(o){
  let html='';
  (o.curtains||[]).forEach((c,i)=>{
    html+=`<div class="cur-sum">
      <h4 style="margin:0 0 6px">ستارة ${i+1} — ${c.location||'-'}</h4>
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(180px,1fr))">
        <div><b>العرض:</b> ${c.width||'-'} سم</div>
        <div><b>الارتفاع:</b> ${c.height||'-'} سم</div>
        <div><b>القماش:</b> ${c.fabric||'—'}</div>
      </div>
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(180px,1fr))">
        <div><b>كود الشيفون:</b> ${c.codeChiffon||'—'}</div>
        <div><b>كود البلاك/مخمل:</b> ${c.codeBlackout||'—'}</div>
      </div>
      ${c.windowPhoto?`<img class="thumb" src="${c.windowPhoto}">`:``}
      ${c.chiffonPhoto?`<img class="thumb" src="${c.chiffonPhoto}">`:``}
      ${c.blackoutPhoto?`<img class="thumb" src="${c.blackoutPhoto}">`:``}
    </div>`;
  });
  return html;
}


function renderOrderCard(o,id){
  const lines=curtainLines(o), mini=curtainMiniImgs(o), sum=fullSummary(o);
  return `<sl-card data-id="${id}">
    <div class="row" style="justify-content:space-between;align-items:flex-start">
      <div>
        <div class="row" style="gap:8px;flex-wrap:wrap">
          <div class="pill">العميل: ${o.name||'-'}</div>
          <a class="pill" href="tel:${o.phone||''}">${o.phone||'-'}</a>
          <div class="pill">${o.address||''}</div>
        </div>
        <div>${lines}</div>
        <div class="row" style="gap:6px;margin-top:6px">${mini||''}</div>
        <sl-details summary="ملخص كامل (صور + قياسات + أسعار)" style="margin-top:8px">${sum}</sl-details>
        ${o.quotationUrl?`<div><a href="${o.quotationUrl}" target="_blank">الكوتيشن (PDF)</a></div>`:''}
      </div>
      <div class="row">
        <sl-button size="small" data-action="approve-order" data-id="${id}" pill variant="success">تم — إلى التركيب والدفعات</sl-button>
        <sl-button size="small" data-action="hold-order" data-id="${id}" pill variant="warning" outline>لم يتم — إلى المعلّقة</sl-button>
        <sl-button size="small" data-action="view-order" data-id="${id}" pill outline>عرض/طباعة</sl-button>
        <sl-button size="small" data-action="delete-order" data-id="${id}" pill variant="danger" outline><i class="bi bi-trash"></i></sl-button>
      </div>
    </div>
  </sl-card>`;
}

function renderPaymentCard(o,id){
  const balance=Math.max(Number(o.total||0)-Number(o.paid||0),0);
  return `<sl-card data-id="${id}">
    <div class="row" style="justify-content:space-between;align-items:flex-start">
      <div>
        <div class="row" style="gap:8px;flex-wrap:wrap">
          <div class="pill">العميل: ${o.name||'-'}</div>
          <div class="pill">العنوان: ${o.address||'-'}</div>
          <a class="pill" href="tel:${o.phone||''}">${o.phone||'-'}</a>
        </div>
        <div class="row" style="gap:12px;margin-top:6px">
          <div class="pill">الإجمالي: ${Number(o.total||0).toFixed(2)}</div>
          <div class="pill">المدفوع: ${Number(o.paid||0).toFixed(2)}</div>
          <div class="pill">المتبقي: <b>${balance.toFixed(2)}</b></div>
        </div>
        ${o.quotationUrl?`<div style="margin-top:6px"><a href="${o.quotationUrl}" target="_blank">الكوتيشن (PDF)</a></div>`:''}
      </div>
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:8px;min-width:320px">
        <sl-input class="payInput" data-id="${id}" type="number" step="0.01" label="إضافة دفعة (AED)"></sl-input>
        <sl-button class="payAdd" data-id="${id}" variant="primary">تسجيل الدفعة</sl-button>
        <sl-button class="invPrint" data-id="${id}" variant="default" outline><i class="bi bi-printer"></i>&nbsp;طباعة فاتورة المتبقي</sl-button>
      </div>
    </div>
  </sl-card>`;
}

function renderInstallCard(o,id){
  const lines=curtainLines(o);
  return `<sl-card data-id="${id}">
    <div class="row" style="justify-content:space-between;align-items:flex-start">
      <div>
        <div class="row" style="gap:8px;flex-wrap:wrap">
          <div class="pill">العميل: ${o.name||'-'}</div>
          <a class="pill" href="tel:${o.phone||''}">${o.phone||'-'}</a>
          <div class="pill">العنوان: ${o.address||'-'}</div>
          <div class="pill">موعد التركيب: ${o.installDate||'-'} ${o.installTime||''}</div>
        </div>
        <div>${lines}</div>
      </div>
      <div class="row">
        <sl-button size="small" data-action="print-install" data-id="${id}" pill outline>طباعة الملخص</sl-button>
        <sl-button size="small" data-action="delete-order" data-id="${id}" pill variant="danger" outline><i class="bi bi-trash"></i></sl-button>
      </div>
    </div>
    <div class="soft" style="margin-top:8px">
      <div class="row" style="justify-content:space-between;align-items:center">
        <b>صور التنفيذ النهائية:</b>
        <label class="pill" style="cursor:pointer">
          <input type="file" class="finishFiles" data-id="${id}" accept="image/*" capture="environment" multiple style="display:none">
          <i class="bi bi-images"></i>&nbsp;اختيار/التقاط الصور
        </label>
      </div>
      <div id="gal-${id}" class="gallery"></div>
      <div class="row" style="margin-top:8px">
        <sl-button class="uploadFinal" data-id="${id}" variant="primary">رفع الصور</sl-button>
        <sl-button class="finishProject" data-id="${id}" variant="success">إنهاء المشروع (دليفري نوت + أرشفة)</sl-button>
      </div>
    </div>
  </sl-card>`;
}

// Event delegation
document.addEventListener('click', async (e)=>{
  const b=e.target.closest('[data-action]'); if(!b) return;
  const action=b.getAttribute('data-action'); const id=b.getAttribute('data-id');
  const {doc:getDocDoc,getDoc,updateDoc,deleteDoc,collection,addDoc,serverTimestamp} = window.FB;
  try{
    if(action==='view-order'){
      const snap=await getDoc(getDocDoc(db,'orders',id)); if(snap.exists()) openOrderDetail(id,snap.data()); else toast('غير موجود','warning');
    }
    if(action==='delete-order'){
      if(!confirm('حذف هذا الطلب نهائياً (سيحاول حذف ملفاته)؟')) return;
      await deleteOrderDeep(id); toast('تم الحذف');
    }
    if(action==='approve-order'){
      // Require schedule date/time before moving to installation
      let date=prompt('حدد تاريخ التركيب (YYYY-MM-DD):', new Date().toISOString().slice(0,10));
      if(!date){ toast('لا يمكن المتابعة بدون تحديد تاريخ التركيب','warning'); return; }
      let time=prompt('حدد وقت التركيب (HH:MM):','10:00');
      if(!time){ toast('لا يمكن المتابعة بدون تحديد وقت التركيب','warning'); return; }
      await updateDoc(getDocDoc(db,'orders',id),{status:'scheduled',isConfirmed:true,confirmedAt:new Date(),installDate:date,installTime:time});
      toast('تم اعتماد الطلب → إلى التركيب والدفعات');
      openPanel('payments');
    }
    
    if(action==='print-install'){
      const snap=await getDoc(getDocDoc(db,'orders',id)); if(!snap.exists()) return;
      const o=snap.data();
      const bodyHtml = `<div id="printBody">
        <h3>ملخص المشروع — ${o.name||''}</h3>
        <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(200px,1fr))">
          <div><b>الهاتف:</b> ${o.phone||''}</div>
          <div><b>العنوان:</b> ${o.address||''}</div>
          <div><b>موعد التركيب:</b> ${o.installDate||''} ${o.installTime||''}</div>
        </div>
        <div class="hr"></div>
        ${fullSummaryNoMoney(o)}
      </div>`;
      // Clone into #printScope and print only that
      let hiddenScope = document.getElementById('printScope');
      if(!hiddenScope){ hiddenScope = document.createElement('div'); hiddenScope.id='printScope'; document.body.appendChild(hiddenScope); }
      hiddenScope.innerHTML = bodyHtml;
      // Use the same approach as order detail: replace with clone for print
      const clone = document.getElementById('printBody').cloneNode(true); clone.id='printScope'; clone.classList.remove('hidden');
      hiddenScope.replaceWith(clone);
      window.print();
      document.body.appendChild(hiddenScope); // restore
    }

    if(action==='hold-order'){
      await updateDoc(getDocDoc(db,'orders',id),{status:'on_hold'});
      toast('تم نقل الطلب إلى المعلّقة');
      openPanel('hold');
    }
    if(action==='wipe-meetings'){
      if(!confirm('حذف كل الاجتماعات؟'))return;
      const {getDocs} = window.FB;
      const snap=await getDocs(collection(db,'meetings')); for(const d of snap.docs){await deleteDoc(d.ref)}
      toast('تم حذف الاجتماعات');
    }
    if(action==='wipe-orders'){
      if(!confirm('حذف كل الطلبات وملفاتها؟'))return;
      const {getDocs} = window.FB;
      const snap=await getDocs(collection(db,'orders'));
      for(const d of snap.docs){await deleteOrderDeep(d.id)} try{await deleteFolder('orders')}catch(_){}
      toast('تم حذف الطلبات');
    }
    if(action==='wipe-completed'){
      if(!confirm('حذف كل المشاريع المنفذة؟'))return;
      const {getDocs} = window.FB;
      const snap=await getDocs(collection(db,'completed_projects')); for(const d of snap.docs){await deleteDoc(d.ref)}
      try{await deleteFolder('completed')}catch(_){}
      toast('حُذفت المشاريع المنفذة');
    }
    if(action==='wipe-all'){
      if($('#wipeConfirm').value.trim()!=='حذف الكل'){return toast('اكتب: حذف الكل للتأكيد','warning')}
      if(!confirm('تأكيد نهائي لحذف كل شيء؟'))return;
      const {getDocs} = window.FB;
      const s1=await getDocs(collection(db,'meetings')); for(const d of s1.docs){await deleteDoc(d.ref)}
      const s2=await getDocs(collection(db,'orders')); for(const d of s2.docs){await deleteOrderDeep(d.id)}
      const s3=await getDocs(collection(db,'completed_projects')); for(const d of s3.docs){await deleteDoc(d.ref)}
      try{await deleteFolder('orders'); await deleteFolder('completed')}catch(_){}
      toast('تم الحذف الكلي');
    }
  }catch(err){ console.error(err); toast((err && (err.code||err.message))||'خطأ','danger') }
});

async function deleteOrderDeep(orderId){
  const {doc:getDocDoc,getDoc,deleteDoc} = window.FB;
  try{ await deleteFolder(`orders/${orderId}`)}catch(_){}
  try{
    const oRef=getDocDoc(db,'orders',orderId); const snap=await getDoc(oRef);
    const meetingId=snap.exists()? (snap.data().meetingId||null) : null;
    await deleteDoc(oRef); if(meetingId){ try{ await deleteDoc(getDocDoc(db,'meetings',meetingId)) }catch(_){ } }
  }catch(e){
    // /*GUARD_FINAL_RESET*/ safety reset
    saveOnceGuard=false; $('#wz_btnSave').removeAttribute('disabled'); toast('تعذر حذف الطلب: '+(e.message||e.code),'danger') }
}

// Bind sections
async function bindMeetings(){
  const {collection,onSnapshot,query,orderBy,addDoc,serverTimestamp,doc,getDoc,deleteDoc} = window.FB;
  const q=query(collection(db,'meetings'),orderBy('scheduledAt','asc'));
  onSnapshot(q,(snap)=>{
    const box=$('#meetingsList'); box.innerHTML='';
    if(snap.empty){ box.innerHTML='<div class="empty">لا يوجد اجتماعات — اضغط "اجتماع جديد".</div>'; return; }
    snap.forEach(docSnap=>{
      const m=docSnap.data(); const id=docSnap.id;
      const card=document.createElement('div');
      // Phone clickable (tel:)
      const telLink = m.customerPhone ? `<a class="pill" href="tel:${m.customerPhone}"><i class="bi bi-telephone"></i>&nbsp;اتصال</a>` : '';
      card.innerHTML=`<sl-card class="mt-card">
        <div class="row" style="justify-content:space-between;align-items:flex-start">
          <div>
            <div class="row" style="gap:6px;flex-wrap:wrap">
              <div class="pill">${m.customerName||'-'}</div>
              ${m.customerPhone?`<a class="pill" href="tel:${m.customerPhone}">${m.customerPhone}</a>`:''}
              ${telLink}
            </div>
            <div class="muted">الموعد: ${m.scheduledAt?.toDate?.()?.toLocaleString?.()||'-'}</div>
            <div class="muted">${m.request||'-'}</div>
            ${m.mapLink? `<a href="${m.mapLink}" target="_blank">رابط الموقع</a>`:''}
            ${m.address?`<div class="muted">${m.address}</div>`:''}
          </div>
          <div class="row">
            <sl-button size="small" data-id="${id}" class="to-wizard" pill outline><i class="bi bi-rulers"></i>&nbsp;فتح نموذج القياس</sl-button>
            <!-- تمت إزالة خيار إنشاء طلب بدون قياس بناءً على طلبك -->
            <sl-button size="small" data-id="${id}" class="del-meeting" pill variant="danger" outline><i class="bi bi-trash"></i></sl-button>
          </div>
        </div>
      </sl-card>`;
      box.appendChild(card);
    });
    box.querySelectorAll('.to-wizard').forEach(btn=>btn.addEventListener('click', async ()=>{
      const {doc,getDoc} = window.FB;
      const mref=doc(db,'meetings',btn.getAttribute('data-id')); const snap=await getDoc(mref);
      if(snap.exists()) openWizard({id:snap.id,...snap.data()}); else openWizard(null);
    }));
    box.querySelectorAll('.del-meeting').forEach(btn=>btn.addEventListener('click', async ()=>{
      const id=btn.getAttribute('data-id'); if(!confirm('حذف الاجتماع؟')) return;
      await deleteDoc(doc(db,'meetings',id)); toast('تم حذف الاجتماع');
    }));
  });

  $('#addMeetingBtn').onclick=()=>$('#dlgMeeting').show();
  $('#newMeeting').onclick=()=>{ openPanel('meetings'); $('#dlgMeeting').show(); };
  $('#saveMeeting').onclick=async()=>{
    try{
      await addDoc(collection(db,'meetings'),{
        customerName:$('#mt_name').value.trim(),
        customerPhone:$('#mt_phone').value.trim(),
        request:$('#mt_request').value.trim(),
        mapLink:$('#mt_link').value.trim(),
        address:$('#mt_address').value.trim(),
        scheduledAt: $('#mt_when').value ? new Date($('#mt_when').value) : null,
        status:'scheduled', createdAt:serverTimestamp()
      });
      $('#dlgMeeting').hide(); toast('تم حفظ الاجتماع');
      ['mt_name','mt_phone','mt_request','mt_link','mt_when','mt_address'].forEach(id=>$('#'+id).value='');
    }catch(e){
    // /*GUARD_FINAL_RESET*/ safety reset
    saveOnceGuard=false; $('#wz_btnSave').removeAttribute('disabled'); toast((e && (e.code||e.message))||'خطأ','danger') }
  };
}

async function bindOrders(){
  const {collection,onSnapshot,query,orderBy} = window.FB;
  const q=query(collection(db,'orders'),orderBy('createdAt','desc'));
  onSnapshot(q,(snap)=>{
    const list=$('#ordersList'); list.innerHTML='';
    if(snap.empty){ list.innerHTML='<div class="empty">لا يوجد طلبات قيد القرار.</div>'; return; }
    snap.forEach(docSnap=>{
      const o=docSnap.data(); const id=docSnap.id;
      if(o.status!=='pending') return; // فقط بانتظار القرار
      const wrapper=document.createElement('div'); wrapper.innerHTML=renderOrderCard(o,id); list.appendChild(wrapper);
    });
    if(!list.children.length) list.innerHTML='<div class="empty">لا يوجد طلبات قيد القرار.</div>';
  });
}

async function bindPayments(){
  const {collection,onSnapshot,query,orderBy} = window.FB;
  const q=query(collection(db,'orders'),orderBy('createdAt','desc'));
  onSnapshot(q,(snap)=>{
    const list=$('#paymentsList'); list.innerHTML='';
    snap.forEach(docSnap=>{
      const o=docSnap.data(); const id=docSnap.id;
      if(!['scheduled','installed'].includes(o.status)) return;
      const wrapper=document.createElement('div'); wrapper.innerHTML=renderPaymentCard(o,id); list.appendChild(wrapper);
      // bind buttons per card
      const card=wrapper.querySelector('sl-card');
      const payBtn=card.querySelector('.payAdd'); const payInput=card.querySelector('.payInput'); const invBtn=card.querySelector('.invPrint');
      payBtn.onclick=async()=>{
        const v=parseFloat(payInput.value||'0'); if(!(v>0)) return toast('أدخل قيمة صحيحة','warning');
        const {doc:updateDocDoc,getDoc,updateDoc} = window.FB;
        const ref=updateDocDoc(db,'orders',id); const snap=await getDoc(ref);
        if(!snap.exists()) return;
        const cur=Number(snap.data().paid||0); await updateDoc(ref,{paid:cur+v}); toast('تم تسجيل الدفعة');
      };
      invBtn.onclick=async()=>{
        const {doc:updateDocDoc,getDoc} = window.FB;
        const ref=updateDocDoc(db,'orders',id); const snap=await getDoc(ref); if(!snap.exists()) return;
        const pdf=makeInvoicePDF(snap.data()); pdf.save(`Invoice_${snap.data().name||id}.pdf`);
      };
    });
    if(!list.children.length) list.innerHTML='<div class="empty">لا يوجد طلبات في قسم الدفعات.</div>';
  });
}

async function bindInstall(){
  const {collection,onSnapshot,query,orderBy,doc:getDocDoc,getDoc,updateDoc,addDoc,deleteDoc} = window.FB;
  const q=query(collection(db,'orders'),orderBy('createdAt','desc'));
  onSnapshot(q,(snap)=>{
    const list=$('#installList'); list.innerHTML=''; let any=false;
    snap.forEach(docSnap=>{
      const o=docSnap.data(); const id=docSnap.id;
      if(!['scheduled','installed'].includes(o.status)) return;
      any=true; const wrapper=document.createElement('div'); wrapper.innerHTML=renderInstallCard(o,id); list.appendChild(wrapper);
      const card=wrapper.querySelector('sl-card');
      let selectedFiles=[];
      card.querySelector('.finishFiles').addEventListener('change',(ev)=>{
        selectedFiles=Array.from(ev.target.files||[]); const gal=card.querySelector(`#gal-${id}`); gal.innerHTML=''; selectedFiles.forEach(f=>{const d=document.createElement('div'); d.textContent=f.name; gal.appendChild(d)});
      });
      card.querySelector('.uploadFinal').onclick=async()=>{
        if(!selectedFiles.length) return toast('اختر الصور أولاً','warning');
        const ref=getDocDoc(db,'orders',id); const snap2=await getDoc(ref); if(!snap2.exists()) return;
        const order=snap2.data(); order.finalPhotos=order.finalPhotos||[];
        for(let f of selectedFiles){
          const data=await fileToDataURL(f);
          const u=await uploadDataURL(`orders/${id}/final/${Date.now()}-${Math.random().toString(36).slice(2)}.jpg`,data);
          order.finalPhotos.push(u);
        }
        await updateDoc(ref,{finalPhotos:order.finalPhotos}); toast('تم رفع الصور'); selectedFiles=[];
        card.querySelector(`#gal-${id}`).innerHTML=order.finalPhotos.map(u=>`<img class="thumb" src="${u}">`).join('');
      };
      
card.querySelector('.finishProject').onclick=async()=>{
  if(!confirm('تأكيد إنهاء المشروع ونقله إلى المشاريع المنفذة؟')) return;
  const {doc:docRef, getDoc, addDoc, collection, deleteDoc, serverTimestamp} = window.FB;
  try{
    const ref = docRef(db,'orders',id);
    const snap = await getDoc(ref);
    if(!snap.exists()) return;
    const o = snap.data();
    const completed = {
      ...o,
      orderId: id,
      completedAt: serverTimestamp(),
      finalPhotos: Array.isArray(o.finalPhotos)? o.finalPhotos : [],
      paymentsHistory: Array.isArray(o.paymentsHistory)? o.paymentsHistory : [],
      quotationUrl: o.quotationUrl || o.pdfUrl || null,
    };
    await addDoc(collection(db,'completed_projects'), completed);
    await deleteDoc(ref);
    card.remove();
    toast('تم إنهاء المشروع ونقله إلى المشاريع المنفذة');
  }catch(e){
    console.error(e); toast('تعذر إنهاء المشروع','danger');
  }
};

          // NOTE: photo migration block removed due to corruption in previous edits.
          // Photos already stored in order.finalPhotos are kept in the completed document.
          // If needed later, implement copy via storage compat APIs.
    });
    $('#installEmpty').classList.toggle('hidden', any);
    if(!any){ $('#installList').innerHTML=''; }
  });
}

async function bindCompleted(){
  const {collection,onSnapshot,query,orderBy,deleteDoc,doc:getDocDoc} = window.FB;
  const q=query(collection(db,'completed_projects'),orderBy('completedAt','desc'));
  onSnapshot(q,(snap)=>{
    const list=$('#completedList'); list.innerHTML='';
    if(snap.empty){ $('#completedEmpty').classList.remove('hidden'); return; }
    $('#completedEmpty').classList.add('hidden');
    snap.forEach(docSnap=>{
      const p=docSnap.data(); const id=docSnap.id;
      const card=document.createElement('sl-card');
      card.innerHTML=`
        <div class="row" style="justify-content:space-between;align-items:flex-start">
          <div>
            <div class="row" style="gap:6px;flex-wrap:wrap">
              <div class="pill">${p.name||'-'}</div>
              <a class="pill" href="tel:${p.phone||''}">${p.phone||'-'}</a>
              <div class="pill">${p.address||'-'}</div>
              <div class="pill">اكتمل: ${new Date(p.completedAt?.seconds? p.completedAt.seconds*1000 : p.completedAt).toLocaleString?.()||''}</div>
            </div>
            ${curtainLines(p)}
            ${p.quotationUrl?`<div><a href="${p.quotationUrl}" target="_blank">الكوتيشن (PDF)</a></div>`:''}
          </div>
          <div class="row">
            <sl-button size="small" data-action="delete-completed" data-id="${id}" pill variant="danger" outline><i class="bi bi-trash"></i></sl-button>
          </div>
        </div>
        <div class="gallery" style="margin-top:8px">${(p.finalPhotos||[]).map(u=>`<img src="${u}">`).join('')}</div>`;
      list.appendChild(card);
      card.querySelector('[data-action="delete-completed"]').onclick=async()=>{
        if(!confirm('حذف من المشاريع المنفذة؟')) return;
        await deleteDoc(getDocDoc(db,'completed_projects',id)); toast('تم الحذف');
      };
    });
  });
}

async function bindOnHold(){
  const {collection,onSnapshot,query,orderBy} = window.FB;
  const q=query(collection(db,'orders'),orderBy('createdAt','desc'));
  onSnapshot(q,(snap)=>{
    const list=$('#holdList'); list.innerHTML=''; let any=false;
    snap.forEach(docSnap=>{
      const o=docSnap.data(); const id=docSnap.id;
      if(o.status!=='on_hold') return; any=true;
      const card=document.createElement('sl-card');
      card.innerHTML=`
        <div class="row" style="justify-content:space-between;align-items:flex-start">
          <div>
            <div class="row" style="gap:6px;flex-wrap:wrap">
              <div class="pill">${o.name||'-'}</div>
              <a class="pill" href="tel:${o.phone||''}">${o.phone||'-'}</a>
              <div class="pill">${o.address||'-'}</div>
            </div>
            ${curtainLines(o)}
          </div>
          <div class="row">
            <sl-button size="small" data-action="approve-order" data-id="${id}" pill variant="success">اعتماد ونقل للتركيب</sl-button>
            <sl-button size="small" data-action="delete-order" data-id="${id}" pill variant="danger" outline><i class="bi bi-trash"></i></sl-button>
          </div>
        </div>`;
      list.appendChild(card);
    });
    $('#holdEmpty').classList.toggle('hidden', any);
    if(!any){ $('#holdList').innerHTML=''; }
  });
}

// Order detail
function openOrderDetail(id,o){
  const box=$('#detailContent');
  const blocks=(o.curtains||[]).map((c,i)=>`
    <div class="cur-sum">
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(160px,1fr))">
        <div><b>ستارة ${i+1}</b></div><div><b>الموقع:</b> ${c.location||'-'}</div><div><b>الأبعاد:</b> ${c.width||'-'} × ${c.height||'-'} سم</div>
      </div>
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(160px,1fr))">
        <div><b>القماش:</b> ${c.fabric||'—'}</div><div><b>كود الشيفون:</b> ${c.codeChiffon||'—'}</div><div><b>كود البلاك/مخمل:</b> ${c.codeBlackout||'—'}</div>
      </div>
      <div><b>السعر:</b> ${c.price||0} + VAT ${c.vat||0} = ${c.total||0} درهم</div>
      <div>${c.windowPhoto?`<img class="thumb" src="${c.windowPhoto}">`:``}${c.chiffonPhoto?`<img class="thumb" src="${c.chiffonPhoto}">`:``}${c.blackoutPhoto?`<img class="thumb" src="${c.blackoutPhoto}">`:``}</div>
    </div>`).join('');
  box.innerHTML=`
    <div id="printBody">
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr))">
        <div><b>الاسم:</b> ${o.name||'-'}</div>
        <div><b>الهاتف:</b> ${o.phone||'-'}</div>
        <div><b>التاريخ:</b> ${o.date||'-'}</div>
      </div>
      <div><b>العنوان:</b> ${o.address||'-'}</div>
      <div class="hr"></div>
      ${blocks}
    </div>`;
  $('#btnPrint').onclick=()=>{
    const scope=$('#printScope');
    const clone=$('#printBody').cloneNode(true); clone.id='printScope'; clone.classList.remove('hidden');
    scope.replaceWith(clone); window.print(); document.body.appendChild(scope);
  };
  $('#dlgOrderDetail').show();
}

// Wizard open
function openWizard(meeting){
  meetingContext=meeting;
  // prefill
  $('#wz_name').value=meeting?.customerName||'';
  $('#wz_phone').value=meeting?.customerPhone||'';
  $('#wz_address').value=meeting?.address||'';
  $('#wz_date').value=(new Date()).toISOString().slice(0,10);
  curtains=[]; curFabricIndex=0; windowPhotoData=null; chiffonPhotoData=null; blackoutPhotoData=null;
  $('#wz_windowPreview').innerHTML=''; $('#wz_measureList').innerHTML='';
  // Strong reset between meetings to avoid leaks
  try{
    $('#wz_fabric_val').value=''; $('#wz_fabric_val').removeAttribute('data-label');
    $('#wz_codeChiffon').value=''; $('#wz_codeBlackout').value='';
    $('#wz_loc').value=''; $('#wz_w').value=''; $('#wz_h').value='';
    const __f1=$('#wz_windowPhoto'); if(__f1) __f1.value='';
    const __f2=$('#wz_photoChiffon'); if(__f2) __f2.value='';
    const __f3=$('#wz_photoBlackout'); if(__f3) __f3.value='';
    if(typeof measureGuard!=='undefined') measureGuard=false;
    if(typeof saveOnceGuard!=='undefined') saveOnceGuard=false;
    $('#wz_btnSave').removeAttribute('disabled');
  }catch(_){}
  buildFabricButtons();
  hide($('#wz-fabrics')); hide($('#wz-summary')); show($('#wz-client')); hide($('#wz-measure'));
  $('#dlgWizard').show();
}

// Actions
$('#wz_client_next').onclick=()=>{ hide($('#wz-client')); show($('#wz-measure')); };
$('#wz_windowPhoto').addEventListener('change', async (e)=>{
  const f=e.target.files?.[0]; if(!f) return; windowPhotoData=await fileToDataURL(f); $('#wz_windowPreview').innerHTML=`<img src="${windowPhotoData}" style="max-width:140px;border:1px solid #eee;border-radius:10px">`;
});
let measureGuard=false;
$('#wz_add_measure').onclick=()=>{
  if(measureGuard) return; measureGuard=true; setTimeout(()=>measureGuard=false, 600); // منع الضغط المتكرر السريع
  const loc=$('#wz_loc').value.trim(), w=parseFloat($('#wz_w').value||0), h=parseFloat($('#wz_h').value||0);
  const unit=0; const fabric='';
  if(!loc || !w || !h){ return toast('أكمل الموقع والأبعاد','warning'); }
  curtains.push({location:loc,width:w,height:h,unit,fabric,windowPhoto:windowPhotoData,chiffonPhoto:chiffonPhotoData,blackoutPhoto:blackoutPhotoData,codeChiffon:$('#wz_codeChiffon').value,codeBlackout:$('#wz_codeBlackout').value});
  windowPhotoData=null; chiffonPhotoData=null; blackoutPhotoData=null;
  $('#wz_loc').value=''; $('#wz_w').value=''; $('#wz_h').value=''; $('#wz_windowPreview').innerHTML='';
  renderMeasureList(); toast('تم حفظ القياس');
};
$('#wz_to_fabrics').onclick=()=>{
  if(!curtains.length) return toast('أضف قياساً واحداً على الأقل','warning');
  curFabricIndex=0; loadFabricForm(); hide($('#wz-measure')); show($('#wz-fabrics'));
};
$('#wz_photoChiffon').addEventListener('change', async (e)=>{const f=e.target.files?.[0]; if(!f) return; chiffonPhotoData=await fileToDataURL(f)});
$('#wz_photoBlackout').addEventListener('change', async (e)=>{const f=e.target.files?.[0]; if(!f) return; blackoutPhotoData=await fileToDataURL(f)});
$('#wz_prevFabric').onclick=()=>{ if(curFabricIndex>0){ curtains[curFabricIndex].codeChiffon=$('#wz_codeChiffon').value; curtains[curFabricIndex].codeBlackout=$('#wz_codeBlackout').value;
    (function(){ try{
      const u=parseFloat($('#wz_fabric_val').value||0)||0;
      const f=$('#wz_fabric_val').getAttribute('data-label')||'';
      if(u>0) curtains[curFabricIndex].unit=u;
      if(f) curtains[curFabricIndex].fabric=f;
      if(chiffonPhotoData) curtains[curFabricIndex].chiffonPhoto=chiffonPhotoData;
      if(blackoutPhotoData) curtains[curFabricIndex].blackoutPhoto=blackoutPhotoData;
    }catch(_){}})();
    (function(){ try{
      const u=parseFloat($('#wz_fabric_val').value||0)||0;
      const f=$('#wz_fabric_val').getAttribute('data-label')||'';
      if(u>0) curtains[curFabricIndex].unit=u;
      if(f) curtains[curFabricIndex].fabric=f;
      if(chiffonPhotoData) curtains[curFabricIndex].chiffonPhoto=chiffonPhotoData;
      if(blackoutPhotoData) curtains[curFabricIndex].blackoutPhoto=blackoutPhotoData;
    }catch(_){}})(); if(blackoutPhotoData) curtains[curFabricIndex].blackoutPhoto=blackoutPhotoData; curFabricIndex--; loadFabricForm(); } };
$('#wz_nextFabric').onclick=()=>{ if(curFabricIndex<curtains.length-1){ curtains[curFabricIndex].codeChiffon=$('#wz_codeChiffon').value; curtains[curFabricIndex].codeBlackout=$('#wz_codeBlackout').value;
    (function(){ try{
      const u=parseFloat($('#wz_fabric_val').value||0)||0;
      const f=$('#wz_fabric_val').getAttribute('data-label')||'';
      if(u>0) curtains[curFabricIndex].unit=u;
      if(f) curtains[curFabricIndex].fabric=f;
      if(chiffonPhotoData) curtains[curFabricIndex].chiffonPhoto=chiffonPhotoData;
      if(blackoutPhotoData) curtains[curFabricIndex].blackoutPhoto=blackoutPhotoData;
    }catch(_){}})();
    (function(){ try{
      const u=parseFloat($('#wz_fabric_val').value||0)||0;
      const f=$('#wz_fabric_val').getAttribute('data-label')||'';
      if(u>0) curtains[curFabricIndex].unit=u;
      if(f) curtains[curFabricIndex].fabric=f;
      if(chiffonPhotoData) curtains[curFabricIndex].chiffonPhoto=chiffonPhotoData;
      if(blackoutPhotoData) curtains[curFabricIndex].blackoutPhoto=blackoutPhotoData;
    }catch(_){}})(); if(blackoutPhotoData) curtains[curFabricIndex].blackoutPhoto=blackoutPhotoData; curFabricIndex++; loadFabricForm(); } };
$('#wz_finishFabrics').onclick=()=>{ curtains[curFabricIndex].codeChiffon=$('#wz_codeChiffon').value; curtains[curFabricIndex].codeBlackout=$('#wz_codeBlackout').value;
    (function(){ try{
      const u=parseFloat($('#wz_fabric_val').value||0)||0;
      const f=$('#wz_fabric_val').getAttribute('data-label')||'';
      if(u>0) curtains[curFabricIndex].unit=u;
      if(f) curtains[curFabricIndex].fabric=f;
      if(chiffonPhotoData) curtains[curFabricIndex].chiffonPhoto=chiffonPhotoData;
      if(blackoutPhotoData) curtains[curFabricIndex].blackoutPhoto=blackoutPhotoData;
    }catch(_){}})();
    (function(){ try{
      const u=parseFloat($('#wz_fabric_val').value||0)||0;
      const f=$('#wz_fabric_val').getAttribute('data-label')||'';
      if(u>0) curtains[curFabricIndex].unit=u;
      if(f) curtains[curFabricIndex].fabric=f;
      if(chiffonPhotoData) curtains[curFabricIndex].chiffonPhoto=chiffonPhotoData;
      if(blackoutPhotoData) curtains[curFabricIndex].blackoutPhoto=blackoutPhotoData;
    }catch(_){}})(); if(blackoutPhotoData) curtains[curFabricIndex].blackoutPhoto=blackoutPhotoData; showSummary(); };
$('#wz_discount').addEventListener('input', ()=>{ const total=parseFloat($('#wz_sumTotal').textContent)||0; const d=parseFloat($('#wz_discount').value)||0; $('#wz_sumAfterDiscount').textContent=(Math.max(total-d,0)).toFixed(2) });

$('#wz_btnPDF').onclick=()=>{
  const order={ name:$('#wz_name').value, phone:$('#wz_phone').value, address:$('#wz_address').value, date:$('#wz_date').value, curtains,
    sumPrice:parseFloat($('#wz_sumPrice').textContent)||0, sumVAT:parseFloat($('#wz_sumVAT').textContent)||0, sumTotal:parseFloat($('#wz_sumTotal').textContent)||0,
    discount:parseFloat($('#wz_discount').value)||0, afterDiscount:parseFloat($('#wz_sumAfterDiscount').textContent)||0, notes:$('#wz_notes').value };
  const pdf = await makeQuotationPDF_withPhotos(order); pdf.save(`Quotation_${order.name||'client'}.pdf`); // تنزيل فوري "من هنا"
  toast('تم تنزيل الكوتيشن PDF');
};
$('#wz_btnSave').onclick=()=>saveOrder({uploadPdf:true}); // يحذف الاجتماع تلقائياً + يرفع PDF + تنزيل فوري
$('#wz_btnClose').onclick=()=>$('#dlgWizard').hide();

// WhatsApp
$('#wz_btnWA').onclick=()=>{
  const text=encodeURIComponent(summaryLines()); const tel=($('#wz_phone').value||'').replace(/\D/g,'');
  const url = tel ? `https://wa.me/${tel}?text=${text}` : `https://wa.me/?text=${text}`;
  window.open(url,'_blank');
};

// Auth + Settings (minimal local-only auth for demo; replace with real Firebase Auth optional)
$('#openSettings').onclick=()=>{
  const c=cfg.get(); ['apiKey','authDomain','projectId','storageBucket','messagingSenderId','appId'].forEach(k=>$('#fb_'+k).value=c[k]||'');
  $('#dlgSettings').show();
};
$('#saveSettings').onclick=()=>{ const o={apiKey:$('#fb_apiKey').value.trim(),authDomain:$('#fb_authDomain').value.trim(),projectId:$('#fb_projectId').value.trim(),storageBucket:$('#fb_storageBucket').value.trim(),messagingSenderId:$('#fb_messagingSenderId').value.trim(),appId:$('#fb_appId').value.trim()}; cfg.set(o); $('#dlgSettings').hide(); location.reload() };
$('#resetSettings').onclick=()=>{ localStorage.removeItem(cfgKey); $('#dlgSettings').hide(); location.reload() };

// Firebase init
(async()=>{
  const c=cfg.get();
  const { initializeApp } = window.FB;
  const { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } = window.FB;
  const { getFirestore } = window.FB;
  const { getStorage } = window.FB;
  if(!isValidCfg(c)){ showNotice('أكمل إعدادات Firebase أولاً.'); try{ document.getElementById('dlgSettings').show(); }catch(_){ } throw new Error('Missing Firebase config'); } app=initializeApp(c); auth=getAuth(app); db=getFirestore(app); storage=getStorage(app);

  // Minimal auth UI
  const setMe=(user)=>{
    hide($('#authCard')); show($('#profileCard')); show($('#meCard')); show($('#qaCard'));
    $('#switchMeetings').onclick=()=>openPanel('meetings');
    $('#switchOrders').onclick=()=>openPanel('orders');
    $('#switchPayments').onclick=()=>openPanel('payments');
    $('#switchInstall').onclick=()=>openPanel('install');
    $('#switchCompleted').onclick=()=>openPanel('completed');
    $('#switchOnHold').onclick=()=>openPanel('hold');
    // profile display (demo: stored in localStorage for simplicity)
    const prof=JSON.parse(localStorage.getItem('va_profile')||'{}');
    $('#pfName').value=prof.name||''; $('#pfPhone').value=prof.phone||''; $('#pfRole').value=prof.role||'sales';
    $('#meName').textContent=prof.name||'—'; $('#meRole').textContent=prof.role||'—'; $('#mePhone').textContent=prof.phone||'—'; $('#mePhone').href=prof.phone?`tel:${prof.phone}`:'#';
    $('#saveProfile').onclick=()=>{ const p={name:$('#pfName').value.trim(),phone:$('#pfPhone').value.trim(),role:$('#pfRole').value}; localStorage.setItem('va_profile',JSON.stringify(p)); $('#meName').textContent=p.name; $('#meRole').textContent=p.role; $('#mePhone').textContent=p.phone; $('#mePhone').href=p.phone?`tel:${p.phone}`:'#'; toast('تم حفظ الملف'); };
    // bind data panels
    bindMeetings(); bindOrders(); bindPayments(); bindInstall(); bindCompleted(); bindOnHold(); openPanel('meetings');
  };
  onAuthStateChanged(auth,(user)=>{ if(user){ setMe(user) } else { show($('#authCard')); hide($('#profileCard')); hide($('#meCard')); hide($('#qaCard')); }});
  $('#login').onclick=async()=>{ try{ await window.signInWithEmailAndPassword(auth,$('#email').value,$('#password').value) }catch(e){ toast((e && (e.code||e.message))||'Auth error','danger') } };
  $('#signup').onclick=async()=>{ try{ await window.createUserWithEmailAndPassword(auth,$('#email').value,$('#password').value) }catch(e){ toast((e && (e.code||e.message))||'Auth error','danger') } };
})();

// Tel link in top user card updates with profile
</script>

<script>
document.addEventListener('DOMContentLoaded', ()=>{
  const sc = document.getElementById('switchCompleted');
  if(sc){ sc.addEventListener('click', ()=>{ openPanel('completed'); try{ bindCompleted(); }catch(e){ console.warn(e); } }); }
  const sp = document.getElementById('switchPayments');
  if(sp){ sp.addEventListener('click', ()=>{ openPanel('payments'); try{ bindPayments(); }catch(e){ console.warn(e); } }); }
  const si = document.getElementById('switchInstall');
  if(si){ si.addEventListener('click', ()=>{ openPanel('install'); try{ bindInstall(); }catch(e){ console.warn(e); } }); }
});
</script>


<script>
const fbRequiredKeys=['apiKey','authDomain','projectId','storageBucket','messagingSenderId','appId'];
function isValidCfg(c){ try{ return c && fbRequiredKeys.every(k=>String(c[k]||'').trim().length>0); }catch(_){ return false; } }
function showNotice(msg=''){ const bar=document.getElementById('noticeBar'); if(!bar) return; if(msg) bar.innerHTML=msg; bar.classList.remove('hidden'); }
function hideNotice(){ const bar=document.getElementById('noticeBar'); if(!bar) return; bar.classList.add('hidden'); }
// Auto-open settings if missing
document.addEventListener('DOMContentLoaded', ()=>{
  const c = (window.cfg&&cfg.get)?cfg.get():JSON.parse(localStorage.getItem('fb_cfg_v1')||'{}');
  if(!isValidCfg(c)){
    showNotice('<b>تنبيه:</b> إعدادات Firebase غير مكتملة. افتح <sl-button size="small" id="quickOpenSettings" pill>الإعدادات</sl-button> وأدخل القيم ثم احفظ.');
    try{ document.getElementById('dlgSettings').show(); }catch(_){}
  }else{ hideNotice(); }
  const q = document.getElementById('quickOpenSettings'); if(q){ q.onclick = ()=>document.getElementById('openSettings').click(); }
});
// Settings dialog handlers
document.addEventListener('DOMContentLoaded', ()=>{
  const required = fbRequiredKeys;
  function fill(){
    let c={};
    try{ c = (window.cfg&&cfg.get)?cfg.get():JSON.parse(localStorage.getItem('fb_cfg_v1')||'{}'); }catch(_){}
    required.forEach(k=>{ const el=document.getElementById('fb_'+k); if(el) el.value = c[k]||''; });
  }
  const btnOpen = document.getElementById('openSettings');
  if(btnOpen){ btnOpen.addEventListener('click', ()=>{ fill(); document.getElementById('dlgSettings').show(); }); }
  const btnSave = document.getElementById('saveSettings');
  if(btnSave){ btnSave.addEventListener('click', ()=>{
    const o = Object.fromEntries(required.map(k=>[k, (document.getElementById('fb_'+k)?.value||'').trim()]));
    try{ localStorage.setItem('fb_cfg_v1', JSON.stringify(o)); }catch(_){}
    try{ if(window.cfg&&cfg.set) cfg.set(o); }catch(_){}
    document.getElementById('dlgSettings').hide(); location.reload();
  }); }
  const btnReset = document.getElementById('resetSettings');
  if(btnReset){ btnReset.addEventListener('click', ()=>{ localStorage.removeItem('fb_cfg_v1'); document.getElementById('dlgSettings').hide(); location.reload(); }); }
});
// Login/Signup handlers show clear errors
function explainAuthError(err){
  const code = err?.code||'';
  if(code.includes('auth/invalid-api-key')) return 'مفتاح API غير صحيح — أدخل قيمة صحيحة.';
  if(code.includes('auth/invalid-credential')) return 'بيانات الدخول غير صحيحة.';
  if(code.includes('auth/user-not-found')) return 'المستخدم غير موجود.';
  if(code.includes('auth/wrong-password')) return 'كلمة المرور غير صحيحة.';
  if(code.includes('auth/too-many-requests')) return 'محاولات كثيرة — جرّب لاحقاً.';
  if(code.includes('auth/network-request-failed')) return 'مشكلة اتصال — تحقق من الإنترنت.';
  if(code.includes('auth/operation-not-supported-in-this-environment')) return 'شغّل الملف على خادم محلي (http://localhost) بدل file://';
  if(code.includes('auth/unauthorized-domain')) return 'النطاق الحالي غير مصرّح — أضفه في Authorized domains.';
  return (err?.message||'Auth error');
}
document.addEventListener('DOMContentLoaded', ()=>{
  const login=document.getElementById('login'); if(login){ login.onclick=async()=>{ try{ await window.window.signInWithEmailAndPassword(auth,document.getElementById('email').value.trim(),document.getElementById('password').value.trim()); }catch(e){ console.error(e); toast(explainAuthError(e),'danger'); } }; }
  const signup=document.getElementById('signup'); if(signup){ signup.onclick=async()=>{ try{ await window.window.createUserWithEmailAndPassword(auth,document.getElementById('email').value.trim(),document.getElementById('password').value.trim()); }catch(e){ console.error(e); toast(explainAuthError(e),'danger'); } }; }
});
</script>


<script>
// FB globals guard
window.addEventListener('DOMContentLoaded', ()=>{
  try{
    if(window.FB){
      // expose convenience globals (without relying on global scope lookups)
      window.signInWithEmailAndPassword = window.FB.signInWithEmailAndPassword;
      window.createUserWithEmailAndPassword = window.FB.createUserWithEmailAndPassword;
      window.getAuth = window.FB.getAuth;
      window.initializeApp = window.FB.initializeApp;
      window.getFirestore = window.FB.getFirestore;
      window.getStorage = window.FB.getStorage;
      window.docRef = window.FB.docRef;
      window.getDoc = window.FB.getDoc;
      window.addDoc = window.FB.addDoc;
      window.updateDoc = window.FB.updateDoc;
      window.deleteDoc = window.FB.deleteDoc;
      window.collection = window.FB.collection;
      window.onSnapshot = window.FB.onSnapshot;
      window.query = window.FB.query;
      window.orderBy = window.FB.orderBy;
      window.arrayUnion = window.FB.arrayUnion;
      window.serverTimestamp = window.FB.serverTimestamp;
      window.getDocDoc = window.FB.getDocDoc || window.FB.docRef;
    }
  }catch(e){ console.warn('FB guard error', e); }
  // toast fallback
  if(typeof window.toast !== 'function'){
    window.toast = (msg, type)=>{ try{ console.log('[toast]', type||'info', msg); alert(msg); }catch(_){ } };
  }
});
</script>


<script>
// ---- Firebase compat init (no await) ----
(function(){
  function getCfg(){
    try{
      if(window.cfg && cfg.get) return cfg.get();
      const raw = localStorage.getItem('fb_cfg_v1');
      return raw ? JSON.parse(raw) : {};
    }catch(_){ return {}; }
  }
  function hasAll(o){
    const keys = ['apiKey','authDomain','projectId','storageBucket','messagingSenderId','appId'];
    return keys.every(k => (o[k]||'').toString().trim().length>0);
  }
  function ensureToast(){
    if(typeof window.toast !== 'function'){
      window.toast = (msg, type)=>{ try{ console.log('[toast]', type||'info', msg); alert(msg); }catch(_){} };
    }
  }
  ensureToast();
  const cfg = getCfg();
  if(!hasAll(cfg)){
    // open settings auto if missing
    setTimeout(()=>{ try{ document.getElementById('dlgSettings').show(); }catch(_){} }, 200);
    window.toast('أكمل إعدادات Firebase أولاً','warning');
    return;
  }
  try{
    // initialize (compat)
    window.app = firebase.initializeApp(cfg);
    window.auth = firebase.auth();
    window.db   = firebase.firestore();
    window.storage = firebase.storage();

    // ensure simple wrappers used elsewhere
    window.signInWithEmailAndPassword = (authInst, email, pass)=> firebase.auth().signInWithEmailAndPassword(email, pass);
    window.createUserWithEmailAndPassword = (authInst, email, pass)=> firebase.auth().createUserWithEmailAndPassword(email, pass);

    console.log('[firebase] compat initialized');
  }catch(e){
    console.error('[firebase init error]', e);
    window.toast((e && (e.message||e.code)) || 'Firebase init error','danger');
  }
})();
</script>


<script>
try{ var app = window.app, auth = window.auth, db = window.db, storage = window.storage; }catch(_){}
</script>

</body>
</html>
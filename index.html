<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
  <meta charset="utf-8"/>
  <title>تطبيق ستائر — (بداية طلب جديد بنموذج فارغ)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --brand:#b58e00; --brand-dark:#8e6c00;
      --bg:#f7f7f7; --card:#fff; --muted:#666; --border:#e5e7eb;
    }
    *{box-sizing:border-box}
    body { font-family: system-ui, -apple-system, "Segoe UI", Arial, "Noto Kufi Arabic", "Amiri", sans-serif; background: var(--bg); padding: 20px; margin: 0; color:#111; }
    .container { background: var(--card); padding: 20px; border-radius: 14px; max-width: 900px; margin: 12px auto; box-shadow: 0 6px 24px rgba(0,0,0,.06); }
    h1,h2,h3 { margin: 0 0 12px }
    h2 { text-align: center; }
    label { margin-top: 10px; display: block; font-weight: 600; }
    input, select, textarea { width: 100%; padding: 10px; margin-top: 6px; border-radius: 10px; border: 1px solid var(--border); background:#fff; }
    textarea{min-height:90px}
    .btns { display:flex; gap:10px; flex-wrap:wrap; justify-content:center; }
    .btn { padding: 10px 16px; border: none; border-radius: 10px; background-color: var(--brand); color: white; cursor: pointer; font-weight:600; }
    .btn.secondary { background:#4b5563; }
    .btn.ghost { background:#fff; color:#111; border:1px solid var(--border) }
    .btn:hover { filter: brightness(.97); }
    .hidden { display: none; }
    .list { background:#fafafa; border:1px dashed var(--border); border-radius:10px; padding:12px; margin-top:10px }
    .row{display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:10px}
    .pill { display:inline-block; background:#eee; padding:4px 10px; border-radius:999px; margin:4px 6px 0 0; font-size:12px }
    .curtain-summary { border:1px solid var(--border); padding:10px; border-radius:10px; margin:8px 0; background:#fff }
    img.preview-img { max-width: 100%; border-radius: 10px; margin-top: 10px; border:1px solid var(--border) }
    .fabric-row { display:flex; flex-wrap:wrap; gap:8px; margin:8px 0; }
    .fabric-btn { padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:#f8f8f8; cursor:pointer }
    .fabric-btn.selected { background:var(--brand); color:#fff; border-color:var(--brand-dark) }
    .hr{height:1px;background:var(--border);margin:10px 0}
    .total-box { background:#f1f1f1; padding:12px; border-radius:10px }
    .del{background:#ef4444;color:#fff}
    /* Stepper */
    .stepper{display:flex;justify-content:space-between;gap:10px;margin:-4px auto 14px;max-width:900px}
    .step{flex:1;display:flex;align-items:center;gap:10px}
    .dot{width:26px;height:26px;border-radius:50%;background:#ddd;color:#555;display:flex;align-items:center;justify-content:center;font-weight:700}
    .step.active .dot{background:var(--brand);color:#fff}
    .step .label{font-size:13px;color:#555;font-weight:700}
    .step.active .label{color:#111}
  </style>
  <!-- jsPDF + AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
  <!-- Stepper -->
  <div class="stepper">
    <div class="step" id="st-client"><div class="dot">1</div><div class="label">العميل</div></div>
    <div class="step" id="st-measure"><div class="dot">2</div><div class="label">القياسات</div></div>
    <div class="step" id="st-fabric"><div class="dot">3</div><div class="label">القماش</div></div>
    <div class="step" id="st-summary"><div class="dot">4</div><div class="label">الملخص</div></div>
  </div>

  <!-- الصفحة الرئيسية -->
  <div class="container" id="page-home">
    <h2>WELCOME V FURNITURE</h2>
    <div class="btns">
      <button type="button" class="btn" onclick="showOrders()">📋 الطلبات السابقة</button>
      <button type="button" class="btn" onclick="startNewOrder()">➕ طلب جديد</button>
    </div>
  </div>

  <!-- الطلبات السابقة -->
  <div class="container hidden" id="page-orders">
    <h2>📋 الطلبات السابقة</h2>
    <div id="ordersList"></div>
    <div class="btns">
      <button type="button" class="btn secondary" onclick="goHome()">🔙 رجوع</button>
    </div>
  </div>

  <!-- بيانات العميل -->
  <div class="container hidden" id="page-client">
    <h2>بيانات العميل / Client Info</h2>
    <div class="row">
      <div><label>الاسم / Name</label><input id="name"/></div>
      <div><label>الهاتف / Phone</label><input id="phone"/></div>
    </div>
    <label>العنوان / Address</label><textarea id="address"></textarea>
    <div class="row">
      <div><label>تاريخ الزيارة / Visit Date</label><input id="date" type="date"/></div>
    </div>
    <div class="btns">
      <button type="button" class="btn secondary" onclick="goHome()">عودة</button>
      <button type="button" class="btn" onclick="goto('page-details'); setStep('measure')">التالي</button>
    </div>
  </div>

  <!-- القياسات أولاً -->
  <div class="container hidden" id="page-details">
    <h2>قياسات النوافذ / Window Measurements</h2>
    <div class="list">
      <div><span class="pill">1</span> أضف موقع كل ستارة + العرض + الارتفاع + صورة.</div>
      <div><span class="pill">2</span> بعد الانتهاء اضغط "اختيار القماش" للانتقال لمرحلة الأقمشة.</div>
    </div>

    <div class="row">
      <div><label>الموقع / Location</label><input id="measure-location" placeholder="مثال: صالة، غرفة نوم..."></div>
      <div><label>العرض (سم) / Width</label><input id="width" type="number"></div>
      <div><label>الارتفاع (سم) / Height</label><input id="height" type="number"></div>
    </div>
    <label>صورة النافذة</label>
    <input id="windowPhoto" type="file" accept="image/*" capture="environment" onchange="previewWindowPhoto(event)">
    <div id="windowPreview"></div>

    <div class="btns">
      <button type="button" class="btn" onclick="addMeasurement()">💾 حفظ القياس</button>
      <button type="button" class="btn ghost" onclick="resetMeasurementForm()">🧹 تفريغ الحقول</button>
    </div>

    <div id="measureList"></div>

    <div class="hr"></div>
    <div class="btns">
      <button type="button" class="btn secondary" onclick="goto('page-client'); setStep('client')">عودة</button>
      <button type="button" class="btn" onclick="startFabricAssignment()">🎨 اختيار القماش</button>
    </div>
  </div>

  <!-- اختيار القماش -->
  <div class="container hidden" id="page-fabrics">
    <h2>اختيار القماش لكل ستارة</h2>
    <div id="fabricHeader" style="text-align:center; margin-bottom:10px;"></div>
    <div class="list" id="fabricInfo"></div>
    <div id="fabricButtonsContainer"></div>

    <input type="hidden" id="fabric" />
    <div class="list">السعر: <b><span id="price">0</span></b> درهم + VAT: <b><span id="vat">0</span></b> = الإجمالي: <b><span id="total">0</span></b> درهم</div>

    <div class="row">
      <div><label>كود قماش الشيفون</label><input id="codeChiffon" placeholder="CH-123"/></div>
      <div><label>صورة قماش الشيفون</label><input accept="image/*" capture="environment" id="photoChiffon" type="file" onchange="previewFabricPhoto(event,'chiffonPreview')" /></div>
      <div id="chiffonPreview"></div>
    </div>

    <div class="row">
      <div><label>كود قماش البلاك أوت / مخمل</label><input id="codeBlackout" placeholder="BO-456"/></div>
      <div><label>صورة قماش البلاك أوت / مخمل</label><input accept="image/*" capture="environment" id="photoBlackout" type="file" onchange="previewFabricPhoto(event,'blackoutPreview')" /></div>
      <div id="blackoutPreview"></div>
    </div>

    <div class="btns">
      <button type="button" class="btn secondary" onclick="prevFabric()">⬅️ السابق</button>
      <button type="button" class="btn" onclick="saveFabricAndNext()">➡️ التالي</button>
      <button type="button" class="btn" onclick="finishFabrics()">✅ إنهاء والذهاب للملخص</button>
    </div>
  </div>

  <!-- الملخص -->
  <div class="container hidden" id="page-summary">
    <h2>ملخص الطلب / Order Summary</h2>
    <div id="summaryContent"></div>

    <label>ملاحظات / Notes</label><textarea id="notes" placeholder="اكتب ملاحظاتك هنا..."></textarea>

    <div class="total-box">
      <p>الإجمالي بدون VAT: <b><span id="sumPrice">0</span></b> درهم</p>
      <p>إجمالي VAT (5%): <b><span id="sumVAT">0</span></b> درهم</p>
      <p><strong>الإجمالي النهائي: <span id="sumTotal">0</span> درهم</strong></p>
      <p>الخصم / Discount: <input id="discount" oninput="updateTotal()" placeholder="0" style="width:140px" type="number"/> درهم</p>
      <p><strong>الإجمالي بعد الخصم: <span id="sumAfterDiscount">0</span> درهم</strong></p>
    </div>
    <div class="btns">
      <button type="button" id="btnPDF" class="btn" onclick="window.generatePDF()">تحميل PDF</button>
      <button type="button" id="btnSave" class="btn" onclick="saveOrder()">💾 حفظ</button>
      <button type="button" class="btn" onclick="sendToWhatsApp()">إرسال واتساب</button>
      <button type="button" class="btn secondary" onclick="goHome()">🏠 الرئيسية</button>
    </div>
  </div>

  <!-- عرض الطلب -->
  <div class="container hidden" id="page-view-order">
    <h2>📄 عرض الطلب</h2>
    <div id="viewOrderContent"></div>
    <div class="btns">
      <button type="button" id="editButton" class="btn">✏️ تعديل</button>
      <button type="button" id="deleteButton" class="btn del">🗑️ حذف</button>
      <button type="button" onclick="printOrder()" class="btn">🖨️ طباعة</button>
      <button type="button" class="btn secondary" onclick="goHome()">🏠 الرئيسية</button>
    </div>
  </div>

  <!-- تعديل الطلب -->
  <div class="container hidden" id="page-edit-order">
    <h2>تعديل الطلب</h2>
    <div id="editOrderList"></div>
    <div class="btns">
      <button type="button" class="btn ghost" onclick="addCurtainInEdit()">➕ إضافة ستارة</button>
      <button type="button" class="btn" onclick="saveEditedOrder()">💾 حفظ التعديلات</button>
      <button type="button" class="btn secondary" onclick="viewOrder(selectedOrderIndex)">إلغاء</button>
    </div>
  </div>

<script>
  // ====== إعدادات ضغط الصور ======
  const MAX_IMG_W = 1200, MAX_IMG_H = 900, JPEG_QUALITY = 0.7, JPEG_QUALITY_FALLBACK = 0.6;

  async function fileToResizedDataURL(file, maxW=MAX_IMG_W, maxH=MAX_IMG_H, quality=JPEG_QUALITY){
    const img = await new Promise((res,rej)=>{
      const fr = new FileReader();
      fr.onload = () => { const im = new Image(); im.onload = () => res(im); im.onerror = rej; im.src = fr.result; };
      fr.onerror = rej; fr.readAsDataURL(file);
    });
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const ratio = Math.min(maxW / img.width, maxH / img.height, 1);
    const w = Math.round(img.width * ratio), h = Math.round(img.height * ratio);
    canvas.width = w; canvas.height = h; ctx.drawImage(img, 0, 0, w, h);
    return canvas.toDataURL('image/jpeg', quality);
  }

  // ====== الحالة العامة ======
  const fabricOptions = [
    {label:"Chiffon - 70 AED / شيفون", price:70},
    {label:"Chiffon Wavy - 90 AED / شيفون ويفي", price:90},
    {label:"Velvet - 90 AED / مخمل", price:90},
    {label:"Velvet Wavy - 100 AED / مخمل ويفي", price:100},
    {label:"Velvet with Chiffon - 110 AED / مخمل مع شيفون", price:110},
    {label:"Velvet Wavy with Chiffon - 130 AED / مخمل ويفي مع شيفون", price:130},
    {label:"Velvet with Chiffon Wavy - 120 AED / مخمل مع شيفون ويفي", price:120},
    {label:"Velvet Wavy with Chiffon Wavy - 150 AED / مخمل ويفي مع شيفون ويفي", price:150},
    {label:"Blackout - 120 AED / بلاك اوت", price:120},
    {label:"Blackout Wavy - 135 AED / بلاك اوت ويفي", price:135},
    {label:"Blackout with Chiffon - 150 AED / بلاك اوت مع شيفون", price:150},
    {label:"Blackout Wavy with Chiffon - 185 AED / بلاك اوت ويفي مع شيفون", price:185},
    {label:"Blackout with Chiffon Wavy - 170 AED / بلاك اوت مع شيفون ويفي", price:170},
    {label:"Blackout Wavy with Chiffon Wavy - 200 AED / بلاك اوت ويفي مع شيفون ويفي", price:200},
    {label:"Roll-up - 120 AED / رول اب", price:120},
  ];
  let curtains = []; // الجلسة الحالية
  let windowPhotoData = null, chiffonPhotoData = null, blackoutPhotoData = null;
  let currentFabricIndex = 0;
  let selectedOrderIndex = null; // للتعديل
  let editOrderObject = null;

  // ====== تنقل ======
  document.addEventListener('DOMContentLoaded', () => { goHome(); buildFabricButtons(); });

  function showOnly(id){ document.querySelectorAll('.container').forEach(c=>c.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }
  function goto(id){ showOnly(id); }
  function setStep(which){
    const ids = ['client','measure','fabric','summary'];
    ids.forEach(k => { const el = document.getElementById('st-'+k); if(!el) return; if(which===k) el.classList.add('active'); else el.classList.remove('active'); });
  }

  // ====== إدارة جلسة الطلب الحالي (تفريغ تام) ======
  function resetSession(){
    curtains = []; currentFabricIndex = 0;
    windowPhotoData = null; chiffonPhotoData = null; blackoutPhotoData = null;

    const ids = ['name','phone','address','date','notes','discount','measure-location','width','height','codeChiffon','codeBlackout'];
    ids.forEach(id=>{ const el=document.getElementById(id); if(el){ el.value=''; }});

    const txts = ['sumPrice','sumVAT','sumTotal','sumAfterDiscount','price','vat','total'];
    txts.forEach(id=>{ const el=document.getElementById(id); if(el){ el.innerText='0'; }});

    ['windowPreview','chiffonPreview','blackoutPreview','measureList','summaryContent','ordersList','fabricInfo','fabricHeader'].forEach(id=>{
      const div=document.getElementById(id); if(div){ div.innerHTML=''; }
    });

    ['windowPhoto','photoChiffon','photoBlackout'].forEach(id=>{ const f=document.getElementById(id); if(f){ f.value=''; }});

    const hiddenFabric = document.getElementById('fabric');
    if(hiddenFabric){ hiddenFabric.value=''; hiddenFabric.removeAttribute('data-label'); }
    document.querySelectorAll('.fabric-btn').forEach(b=>b.classList.remove('selected'));
  }

  function startNewOrder(){ resetSession(); setStep('client'); goto('page-client'); }
  function goHome(){ resetSession(); setStep(null); goto('page-home'); }

  // ====== معاينات الصور ======
  async function previewWindowPhoto(e){ const f=e.target.files&&e.target.files[0]; if(f){ windowPhotoData = await fileToResizedDataURL(f); document.getElementById("windowPreview").innerHTML='<img src="'+windowPhotoData+'" class="preview-img">'; } }
  function resetMeasurementForm(){ ['measure-location','width','height'].forEach(id=>document.getElementById(id).value=''); const file=document.getElementById('windowPhoto'); if(file) file.value=''; windowPhotoData=null; document.getElementById('windowPreview').innerHTML=''; }

  // ====== القياسات ======
  function addMeasurement(){
    const loc=(document.getElementById("measure-location").value||'').trim();
    const w=parseFloat(document.getElementById("width").value)||0;
    const h=parseFloat(document.getElementById("height").value)||0;
    if(!loc){ alert("اكتب موقع الستارة"); return; }
    if(!w||!h){ alert("أدخل العرض والارتفاع"); return; }
    curtains.push({location:loc,width:w,height:h,windowPhoto:windowPhotoData,fabric:null,price:0,vat:0,total:0,codeChiffon:"",codeBlackout:"",chiffonPhoto:null,blackoutPhoto:null});
    resetMeasurementForm();
    renderMeasureList();
    alert("تم حفظ القياس ✅");
  }
  function renderMeasureList(){
    const cont=document.getElementById("measureList");
    if(!curtains.length){cont.innerHTML='';return;}
    let html='<h3 style="text-align:center">القياسات المُضافة</h3>';
    curtains.forEach((c,i)=>{
      html+= '<div class="curtain-summary"><strong>ستارة '+(i+1)+' - ('+c.location+')</strong><div>العرض: '+c.width+' سم — الارتفاع: '+c.height+' سم</div>'+(c.windowPhoto?'<img src="'+c.windowPhoto+'" class="preview-img">':'')+'</div>';
    });
    cont.innerHTML=html;
  }

  // ====== اختيار القماش ======
  function buildFabricButtons(){
    const cont=document.getElementById('fabricButtonsContainer'); if(!cont) return;
    cont.innerHTML=''; let row=null;
    fabricOptions.forEach((opt,idx)=>{
      if(idx%4===0){ row=document.createElement('div'); row.className='fabric-row'; cont.appendChild(row); }
      const b=document.createElement('button'); b.type='button'; b.className='fabric-btn'; b.textContent=opt.label;
      b.dataset.label=opt.label; b.dataset.price=opt.price;
      b.onclick=()=>{ document.querySelectorAll('.fabric-btn').forEach(x=>x.classList.remove('selected')); b.classList.add('selected'); document.getElementById('fabric').value=opt.price; document.getElementById('fabric').setAttribute('data-label', opt.label); calcCurtainPriceForIndex(currentFabricIndex); };
      row.appendChild(b);
    });
  }
  async function previewFabricPhoto(e, previewId){
    const f=e.target.files&&e.target.files[0];
    if(f){
      const b64 = await fileToResizedDataURL(f);
      if(previewId==='chiffonPreview') chiffonPhotoData=b64; else blackoutPhotoData=b64;
      document.getElementById(previewId).innerHTML='<img src="'+b64+'" class="preview-img">';
      calcCurtainPriceForIndex(currentFabricIndex);
    }
  }
  function startFabricAssignment(){ if(!curtains.length){ alert("أضف قياسًا واحدًا على الأقل أولاً."); return; } currentFabricIndex=0; loadFabricForm(); goto('page-fabrics'); setStep('fabric'); }
  function loadFabricForm(){
    const c=curtains[currentFabricIndex];
    document.getElementById("fabricHeader").innerText='ستارة '+(currentFabricIndex+1)+' من '+curtains.length;
    document.getElementById("fabricInfo").innerHTML='<div><strong>الموقع:</strong> '+c.location+'</div><div><strong>العرض:</strong> '+c.width+' سم</div><div><strong>الارتفاع:</strong> '+c.height+' سم</div>';
    document.querySelectorAll('.fabric-btn').forEach(b=>b.classList.remove('selected'));
    if(c.fabric){
      const btn=[...document.querySelectorAll('.fabric-btn')].find(x=>x.dataset.label===c.fabric);
      if(btn){ btn.classList.add('selected'); document.getElementById('fabric').value=btn.dataset.price; document.getElementById('fabric').setAttribute('data-label', btn.dataset.label); }
    }else{ document.getElementById('fabric').value=''; document.getElementById('fabric').removeAttribute('data-label'); }
    document.getElementById("price").innerText = c.price ? Number(c.price).toFixed(2) : "0";
    document.getElementById("vat").innerText = c.vat ? Number(c.vat).toFixed(2) : "0";
    document.getElementById("total").innerText = c.total ? Number(c.total).toFixed(2) : "0";
    document.getElementById("codeChiffon").value = c.codeChiffon || "";
    document.getElementById("codeBlackout").value = c.codeBlackout || "";
    chiffonPhotoData = c.chiffonPhoto || null; blackoutPhotoData = c.blackoutPhoto || null;
    document.getElementById('chiffonPreview').innerHTML = c.chiffonPhoto?'<img src="'+c.chiffonPhoto+'" class="preview-img">':'';
    document.getElementById('blackoutPreview').innerHTML = c.blackoutPhoto?'<img src="'+c.blackoutPhoto+'" class="preview-img">':'';
    const pc=document.getElementById('photoChiffon'); if(pc) pc.value='';
    const pb=document.getElementById('photoBlackout'); if(pb) pb.value='';
  }
  function calcCurtainPriceForIndex(idx){
    const c=curtains[idx]; const w=parseFloat(c.width)||0; const h=parseFloat(c.height)||0; const fabricPrice=parseFloat(document.getElementById("fabric").value)||0;
    const area=(w/100)*(h/100); const price=area*fabricPrice; const vat=price*0.05; const total=price+vat;
    document.getElementById("price").innerText=price.toFixed(2);
    document.getElementById("vat").innerText=vat.toFixed(2);
    document.getElementById("total").innerText=total.toFixed(2);
  }
  function saveFabricAndNext(){
    const c=curtains[currentFabricIndex];
    const fabricLabel=document.getElementById("fabric").getAttribute("data-label") || c.fabric;
    const fabricUnit=parseFloat(document.getElementById("fabric").value)||0;
    if(!fabricLabel){ alert("اختر نوع القماش أولاً"); return; }
    const area=(c.width/100)*(c.height/100); const price=area*fabricUnit; const vat=price*0.05; const total=price+vat;
    c.fabric=fabricLabel; c.price=price.toFixed(2); c.vat=vat.toFixed(2); c.total=total.toFixed(2);
    c.codeChiffon=document.getElementById("codeChiffon").value||""; c.codeBlackout=document.getElementById("codeBlackout").value||"";
    c.chiffonPhoto=chiffonPhotoData; c.blackoutPhoto=blackoutPhotoData;
    if(currentFabricIndex<curtains.length-1){ currentFabricIndex++; loadFabricForm(); } else { finishFabrics(); }
  }
  function prevFabric(){ if(currentFabricIndex>0){ currentFabricIndex--; loadFabricForm(); } else alert("هذه أول ستارة"); }
  function finishFabrics(){ showSummary(); setStep('summary'); }

  // ====== الملخص والحسابات ======
  function showSummary(){
    goto('page-summary');
    const s=document.getElementById("summaryContent"); let html=''; let totalPrice=0,totalVAT=0;
    html+='<div class="row"><div><b>الاسم:</b> '+(val('name')||'')+'</div><div><b>الهاتف:</b> '+(val('phone')||'')+'</div><div><b>التاريخ:</b> '+(val('date')||'')+'</div></div><div><b>العنوان:</b> '+(val('address')||'')+'</div><div class="hr"></div>';
    curtains.forEach((c,i)=>{
      html+='<div class="curtain-summary"><h3>ستارة '+(i+1)+' — '+c.location+'</h3>'+
            '<div class="row"><div><b>العرض:</b> '+c.width+' سم</div><div><b>الارتفاع:</b> '+c.height+' سم</div><div><b>القماش:</b> '+(c.fabric||'—')+'</div></div>'+
            '<div class="row"><div><b>كود الشيفون:</b> '+(c.codeChiffon||'—')+'</div><div><b>كود البلاك/مخمل:</b> '+(c.codeBlackout||'—')+'</div></div>'+
            '<div><b>السعر:</b> '+(c.price||0)+' + VAT '+(c.vat||0)+' = '+(c.total||0)+' درهم</div>'+
            (c.windowPhoto?'<img src="'+c.windowPhoto+'" class="preview-img">':'')+
            (c.chiffonPhoto?'<img src="'+c.chiffonPhoto+'" class="preview-img">':'')+
            (c.blackoutPhoto?'<img src="'+c.blackoutPhoto+'" class="preview-img">':'')+
            '</div>';
      totalPrice += parseFloat(c.price)||0; totalVAT += parseFloat(c.vat)||0;
    });
    document.getElementById("sumPrice").innerText=totalPrice.toFixed(2);
    document.getElementById("sumVAT").innerText=totalVAT.toFixed(2);
    document.getElementById("sumTotal").innerText=(totalPrice+totalVAT).toFixed(2);
    s.innerHTML=html; updateTotal();
  }
  function updateTotal(){ const total=parseFloat(txt('sumTotal'))||0; const discount=parseFloat(val('discount'))||0; document.getElementById('sumAfterDiscount').innerText=(total-discount).toFixed(2); }

  // ====== الحفظ (يضغط الصور قبل التخزين) ======
  function canSave(){
    if(!curtains.length){ alert('أضف ستارة واحدة على الأقل قبل الحفظ.'); return false; }
    for(let i=0;i<curtains.length;i++){ if(!curtains[i].fabric){ alert('اختر القماش لكل الستائر قبل الحفظ. ستارة رقم: '+(i+1)); return false; } }
    return true;
  }
  async function compressAllCurtainImages(extra=false){
    const maxW = extra ? 900 : MAX_IMG_W, maxH = extra ? 700 : MAX_IMG_H, q = extra ? JPEG_QUALITY_FALLBACK : JPEG_QUALITY;
    async function resizeDataURL(dataURL){ if(!dataURL) return null; const img=await new Promise((r,j)=>{ const im=new Image(); im.onload=()=>r(im); im.onerror=j; im.src=dataURL; }); const canvas=document.createElement('canvas'); const ctx=canvas.getContext('2d'); const ratio=Math.min(maxW/img.width, maxH/img.height, 1); const w=Math.round(img.width*ratio), h=Math.round(img.height*ratio); canvas.width=w; canvas.height=h; ctx.drawImage(img,0,0,w,h); return canvas.toDataURL('image/jpeg', q); }
    for(const c of curtains){ c.windowPhoto=await resizeDataURL(c.windowPhoto); c.chiffonPhoto=await resizeDataURL(c.chiffonPhoto); c.blackoutPhoto=await resizeDataURL(c.blackoutPhoto); }
  }

  let saving=false;
  async function saveOrder(){
    try{
      if(saving) return;
      if(!canSave()) return;
      saving=true;
      const btn=document.getElementById('btnSave'); if(btn){ btn.disabled=true; btn.textContent='... جارٍ الحفظ'; }

      await compressAllCurtainImages(false);

      const client={ name:val('name'), phone:val('phone'), address:val('address'), date:val('date'), notes:val('notes'),
        curtains:curtains, total:txt('sumTotal'), discount:val('discount'), afterDiscount:txt('sumAfterDiscount'), savedAt:new Date().toISOString() };

      const orders=getOrders(); orders.push(client);
      try{ setOrders(orders); }
      catch(err){ console.warn('Quota error, retry with stronger compression...', err); await compressAllCurtainImages(true); orders[orders.length-1].curtains=curtains; setOrders(orders); }

      alert('تم حفظ الطلب ✅');
      resetSession();
      viewOrder(orders.length-1);
      saving=false; if(btn){ btn.disabled=false; btn.textContent='💾 حفظ'; }
    }catch(e){
      saving=false; const btn=document.getElementById('btnSave'); if(btn){ btn.disabled=false; btn.textContent='💾 حفظ'; }
      alert('تعذر الحفظ: ربما حجم الصور كبير جدًا. امسح بعض الطلبات القديمة أو التقط صورًا أصغر.\nالتفاصيل: '+e.message);
    }
  }
  function getOrders(){ return JSON.parse(localStorage.getItem("curtainOrders")||"[]"); }
  function setOrders(data){ localStorage.setItem("curtainOrders", JSON.stringify(data)); }
  function showOrders(){
    const orders=getOrders(); let html='';
    if(!orders.length) html='<p>لا توجد طلبات محفوظة.</p>';
    else orders.forEach((o,i)=>{
      html+='<div class="curtain-summary"><div class="row"><div><b>'+escapeHtml(o.name||'')+'</b></div><div>'+escapeHtml(o.date||'')+'</div><div>الإجمالي: '+escapeHtml(o.total||'0')+' درهم</div></div>'+
            '<div class="btns" style="justify-content:flex-start;margin-top:6px">'+
            '<button type="button" class="btn" onclick="viewOrder('+i+')">👁️ عرض</button>'+
            '<button type="button" class="btn" onclick="editOrder('+i+')">✏️ تعديل</button>'+
            '<button type="button" class="btn del" onclick="deleteOrder('+i+')">🗑️ حذف</button>'+
            '</div></div>';
    });
    document.getElementById("ordersList").innerHTML=html; goto('page-orders'); setStep(null);
  }
  function deleteOrder(i){ const orders=getOrders(); if(confirm('حذف هذا الطلب؟')){ orders.splice(i,1); setOrders(orders); showOrders(); } }
  function viewOrder(i){
    const o=getOrders()[i]; selectedOrderIndex=i;
    let html='<div class="row"><div><b>الاسم:</b> '+escapeHtml(o.name||'')+'</div><div><b>الهاتف:</b> '+escapeHtml(o.phone||'')+'</div><div><b>التاريخ:</b> '+escapeHtml(o.date||'')+'</div></div><div><b>العنوان:</b> '+escapeHtml(o.address||'')+'</div><div><b>ملاحظات:</b> '+escapeHtml(o.notes||'')+'</div><div class="hr"></div>';
    (o.curtains||[]).forEach((c,idx)=>{
      html+='<div class="curtain-summary"><h3>ستارة '+(idx+1)+' — '+escapeHtml(c.location||'')+'</h3>'+
            '<div class="row"><div><b>العرض:</b> '+c.width+' سم</div><div><b>الارتفاع:</b> '+c.height+' سم</div><div><b>القماش:</b> '+escapeHtml(c.fabric||'—')+'</div></div>'+
            '<div class="row"><div><b>كود الشيفون:</b> '+escapeHtml(c.codeChiffon||'—')+'</div><div><b>كود البلاك/مخمل:</b> '+escapeHtml(c.codeBlackout||'—')+'</div></div>'+
            '<div><b>السعر:</b> '+(c.price||0)+' + VAT '+(c.vat||0)+' = '+(c.total||0)+' درهم</div>'+
            (c.windowPhoto?'<img src="'+c.windowPhoto+'" class="preview-img">':'')+
            (c.chiffonPhoto?'<img src="'+c.chiffonPhoto+'" class="preview-img">':'')+
            (c.blackoutPhoto?'<img src="'+c.blackoutPhoto+'" class="preview-img">':'')+
            '</div>';
    });
    html+='<div class="hr"></div><div class="row"><div><b>الإجمالي:</b> '+escapeHtml(o.total||'0')+' درهم</div><div><b>الخصم:</b> '+escapeHtml(o.discount||'0')+' درهم</div><div><b>بعد الخصم:</b> '+escapeHtml(o.afterDiscount||o.total||'0')+' درهم</div></div>';
    document.getElementById("viewOrderContent").innerHTML=html;
    document.getElementById("editButton").onclick=()=>editOrder(i);
    document.getElementById("deleteButton").onclick=()=>{ deleteOrder(i); goHome(); };
    goto('page-view-order'); setStep(null);
  }

  // ====== تعديل الطلب ======
  function editOrder(i){
    selectedOrderIndex=i; editOrderObject = JSON.parse(JSON.stringify(getOrders()[i])); // deep copy
    renderEditOrder(); goto('page-edit-order'); setStep('measure');
  }
  function renderEditOrder(){
    const o=editOrderObject; const wrap=document.getElementById('editOrderList');
    let html='<div class="curtain-summary"><h3>بيانات العميل</h3>'+
             '<label>الاسم</label><input id="e-name" value="'+escapeAttr(o.name||'')+'">'+
             '<label>الهاتف</label><input id="e-phone" value="'+escapeAttr(o.phone||'')+'">'+
             '<label>العنوان</label><textarea id="e-address">'+escapeHtml(o.address||'')+'</textarea>'+
             '<label>التاريخ</label><input id="e-date" type="date" value="'+escapeAttr(o.date||'')+'">'+
             '<label>ملاحظات</label><textarea id="e-notes">'+escapeHtml(o.notes||'')+'</textarea>'+
             '</div><h3>ستائر الطلب</h3>';
    (o.curtains||[]).forEach((c,idx)=>{ html+= curtainEditor(c, idx); });
    wrap.innerHTML=html; bindEditInputs();
  }
  function curtainEditor(c, idx){
    const opts=fabricOptions.map(opt=>'<option '+(opt.label===c.fabric?'selected':'')+' value="'+opt.label+'|'+opt.price+'">'+opt.label+'</option>').join('');
    return '<div class="curtain-summary" data-idx="'+idx+'">'+
           '<div class="row">'+
           '<div><label>الموقع</label><input id="e-loc-'+idx+'" value="'+escapeAttr(c.location||'')+'"></div>'+
           '<div><label>العرض (سم)</label><input id="e-w-'+idx+'" type="number" value="'+(c.width||0)+'"></div>'+
           '<div><label>الارتفاع (سم)</label><input id="e-h-'+idx+'" type="number" value="'+(c.height||0)+'"></div>'+
           '</div>'+
           '<div class="row">'+
           '<div><label>القماش</label><select id="e-fabric-'+idx+'">'+opts+'</select></div>'+
           '<div><label>كود الشيفون</label><input id="e-chcode-'+idx+'" value="'+escapeAttr(c.codeChiffon||'')+'"></div>'+
           '<div><label>كود البلاك/مخمل</label><input id="e-bocode-'+idx+'" value="'+escapeAttr(c.codeBlackout||'')+'"></div>'+
           '</div>'+
           '<div class="row">'+
           '<div><label>صورة النافذة</label><input id="e-winphoto-'+idx+'" type="file" accept="image/*"></div>'+
           '<div><label>صورة الشيفون</label><input id="e-chphoto-'+idx+'" type="file" accept="image/*"></div>'+
           '<div><label>صورة البلاك/مخمل</label><input id="e-bophoto-'+idx+'" type="file" accept="image/*"></div>'+
           '</div>'+
           '<div class="row">'+
           (c.windowPhoto?'<img src="'+c.windowPhoto+'" class="preview-img">':'')+
           (c.chiffonPhoto?'<img src="'+c.chiffonPhoto+'" class="preview-img">':'')+
           (c.blackoutPhoto?'<img src="'+c.blackoutPhoto+'" class="preview-img">':'')+
           '</div>'+
           '<div class="btns" style="justify-content:flex-end"><button type="button" class="btn del" onclick="removeCurtainInEdit('+idx+')">حذف هذه الستارة</button></div>'+
           '</div>';
  }
  function bindEditInputs(){
    const o=editOrderObject;
    ['name','phone','address','date','notes'].forEach(k=>{ const el=document.getElementById('e-'+k); if(el){ el.oninput=()=>{ o[k]=el.value; }; }});
    (o.curtains||[]).forEach((c,idx)=>{
      const loc=gid('e-loc-'+idx), w=gid('e-w-'+idx), h=gid('e-h-'+idx), fa=gid('e-fabric-'+idx), ch=gid('e-chcode-'+idx), bo=gid('e-bocode-'+idx);
      [loc,w,h,fa,ch,bo].forEach(el=>{ if(!el) return; el.oninput=()=>applyCurtainCalc(idx); el.onchange=()=>applyCurtainCalc(idx); });
      const fwin=gid('e-winphoto-'+idx), fch=gid('e-chphoto-'+idx), fbo=gid('e-bophoto-'+idx);
      if(fwin) fwin.onchange = async e=>{ const f=e.target.files&&e.target.files[0]; if(f){ c.windowPhoto=await fileToResizedDataURL(f); renderEditOrder(); } };
      if(fch)  fch.onchange  = async e=>{ const f=e.target.files&&e.target.files[0]; if(f){ c.chiffonPhoto=await fileToResizedDataURL(f); renderEditOrder(); } };
      if(fbo)  fbo.onchange  = async e=>{ const f=e.target.files&&e.target.files[0]; if(f){ c.blackoutPhoto=await fileToResizedDataURL(f); renderEditOrder(); } };
    });
  }
  function applyCurtainCalc(idx){
    const c=editOrderObject.curtains[idx];
    c.location = val('e-loc-'+idx);
    c.width = parseFloat(val('e-w-'+idx))||0;
    c.height= parseFloat(val('e-h-'+idx))||0;
    c.codeChiffon = val('e-chcode-'+idx);
    c.codeBlackout= val('e-bocode-'+idx);
    const [label,unitStr]=(val('e-fabric-'+idx)||'|0').split('|'); c.fabric=label;
    const unit=parseFloat(unitStr)||0; const area=(c.width/100)*(c.height/100); const price=area*unit; const vat=price*0.05; const total=price+vat;
    c.price=price.toFixed(2); c.vat=vat.toFixed(2); c.total=total.toFixed(2);
  }
  function addCurtainInEdit(){ editOrderObject.curtains.push({location:'',width:0,height:0,windowPhoto:null,fabric:fabricOptions[0].label,price:'0',vat:'0',total:'0',codeChiffon:'',codeBlackout:'',chiffonPhoto:null,blackoutPhoto:null}); renderEditOrder(); }
  function removeCurtainInEdit(idx){ if(confirm('حذف هذه الستارة؟')){ editOrderObject.curtains.splice(idx,1); renderEditOrder(); } }
  function saveEditedOrder(){
    const orders=getOrders();
    let totalPrice=0,totalVAT=0; (editOrderObject.curtains||[]).forEach(c=>{ totalPrice+=(+c.price||0); totalVAT+=(+c.vat||0); });
    editOrderObject.total=(totalPrice+totalVAT).toFixed(2);
    if(!editOrderObject.afterDiscount) editOrderObject.afterDiscount=editOrderObject.total;
    orders[selectedOrderIndex]=editOrderObject; setOrders(orders);
    alert('تم حفظ التعديلات ✅'); viewOrder(selectedOrderIndex);
  }

  // ====== PDF مُحسّن (مسافات أكبر) ======
  function getFabricOnly(txt){ if(!txt) return ''; if(txt.includes('Velvet')) return 'Velvet with Chiffon'; if(txt.includes('Blackout')) return 'Blackout with Chiffon'; if(txt.includes('Chiffon')) return 'Chiffon'; return txt; }
  window.generatePDF = async function () {
    try{
      if(!window.jspdf || !window.jspdf.jsPDF){ alert('مكتبة PDF لم تُحمّل. تأكد من الاتصال ثم حاول.'); return; }
      const doc = new window.jspdf.jsPDF("p","mm","a4");
      const W=210, M=14, CONTENT=W-2*M; let y = 16;
      const LINE = 6;
      const IMG_W=44, IMG_H=32, LABEL_GAP=4, ROW_GAP=16, HEADER_GAP=8;

      function ensurePage(extra=0){ if(y+extra>290){ doc.addPage(); y=16; } }
      function writeBlock(text){ const lines=doc.splitTextToSize(text, CONTENT); lines.forEach(ln=>{ ensurePage(LINE); doc.text(ln, M, y); y+=LINE; }); }

      const logo = new Image(); logo.src = "https://i.postimg.cc/L4QwkTxg/LOGO23333.png"; await new Promise(res=>logo.onload=res);
      const ratio = logo.width / logo.height, h=18, w=ratio*h, x=(W-w)/2;
      doc.addImage(logo,"PNG",x,y,w,h); y += h + 4;

      doc.setFontSize(11);
      writeBlock("Client Name: " + (val('name')||""));
      writeBlock("Phone: " + (val('phone')||""));
      writeBlock("Address: " + (val('address')||""));
      writeBlock("Visit Date: " + (val('date')||""));
      const notes=val('notes'); if(notes){ writeBlock("Notes: " + notes); }

      ensurePage(HEADER_GAP+8); doc.setFontSize(14); doc.text("Order Summary", W/2, y+HEADER_GAP/2, {align:"center"}); y+=HEADER_GAP+6;

      const head=[["Location","Width","Height","Fabric","Chiffon Code","Blackout Code","Price (AED)"]];
      const rows=[];
      let totalPrice=0,totalVAT=0;
      curtains.forEach(c=>{ totalPrice+=(+c.price||0); totalVAT+=(+c.vat||0); rows.push([c.location||"", String(c.width||""), String(c.height||""), getFabricOnly(c.fabric||""), c.codeChiffon||"", c.codeBlackout||"", (c.total||"0")+" AED"]); });
      doc.autoTable({head:head, body:rows, startY:y, styles:{fontSize:9, cellPadding:1.5}, headStyles:{fillColor:[181,142,0]}, margin:{left:M, right:M}});
      y = doc.lastAutoTable.finalY + HEADER_GAP;

      for(let i=0;i<curtains.length;i++){
        const c=curtains[i];
        ensurePage(IMG_H + LABEL_GAP + ROW_GAP + 8);
        doc.setFontSize(11); doc.text("Curtain "+(i+1)+" Images", M, y); y += 6;
        async function add(src, x, label){
          if(!src) return;
          const img=new Image(); img.src=src; await new Promise(r=>img.onload=r);
          ensurePage(IMG_H + LABEL_GAP + ROW_GAP);
          doc.addImage(img,'JPEG', x, y, IMG_W, IMG_H);
          doc.setFontSize(9); doc.text(label, x, y + IMG_H + LABEL_GAP);
        }
        await add(c.windowPhoto, M, "Window");
        await add(c.chiffonPhoto, M+IMG_W+4, "Chiffon");
        await add(c.blackoutPhoto, M+(IMG_W+4)*2, "Blackout");
        y += IMG_H + LABEL_GAP + ROW_GAP;
      }

      y += HEADER_GAP;
      ensurePage(4*LINE + 8);
      doc.setFontSize(11);
      writeBlock("Total without VAT: " + totalPrice.toFixed(2) + " AED");
      writeBlock("VAT (5%): " + totalVAT.toFixed(2) + " AED");
      writeBlock("Final Total: " + (totalPrice+totalVAT).toFixed(2) + " AED");
      const disc=parseFloat(val('discount')||'0')||0;
      if(disc>0){ writeBlock("Discount: -" + disc.toFixed(2) + " AED"); writeBlock("Total After Discount: " + (totalPrice+totalVAT-disc).toFixed(2) + " AED"); }

      y += 4;
      ensurePage(6*LINE + 8);
      doc.setFontSize(10); writeBlock("Payment Terms:");
      ["(I) - 75% of the contract value shall be payable as advance payment at the time of signing the contract.",
       "(II) - 25% at Finishing 50% of work.",
       "(III) - The payment shall be released as per the mutually agreed terms & conditions.",
       "(IV) - Any additional works will be charged."
      ].forEach(t=>writeBlock(t));

      const safe=(val('name')||'Client').replace(/[^a-zA-Z0-9؀-ۿ ]+/g,'_').substring(0,24).trim();
      doc.save(safe+"_Curtain_Order.pdf");
    }catch(e){ alert('PDF Error: '+e.message); }
  };

  // ====== الطباعة وواتساب ======
  function printOrder(){ const c=document.getElementById("viewOrderContent").innerHTML; const w=window.open('','','width=900,height=700'); w.document.write('<html><head><title>طباعة الطلب</title><style>body{font-family:system-ui,Arial;direction:rtl;padding:20px}.curtain-summary{border:1px solid #ddd;border-radius:10px;margin:10px 0;padding:10px}img{max-width:220px;max-height:150px;display:inline-block;margin:6px;border:1px solid #eee;border-radius:8px}</style></head><body onload="window.print(); window.close();">'+c+'</body></html>'); w.document.close(); }
  function sendToWhatsApp(){
    const name=val('name'), phone=val('phone'), address=val('address'), date=val('date'), notes=val('notes');
    let msg='طلب ستائر\n'+'الاسم: '+name+'\nالهاتف: '+phone+'\nالعنوان: '+address+'\nتاريخ الزيارة: '+date+'\n';
    curtains.forEach((c,i)=>{ msg+='\nستارة '+(i+1)+' ('+c.location+')\nالعرض: '+c.width+' سم\nالارتفاع: '+c.height+' سم\nنوع القماش: '+(c.fabric||'—')+'\nكود الشيفون: '+(c.codeChiffon||'—')+'\nكود البلاك/مخمل: '+(c.codeBlackout||'—')+'\nالسعر: '+(c.price||0)+' + '+(c.vat||0)+' VAT = '+(c.total||0)+' درهم\n'; });
    const total=txt('sumTotal'), discount=val('discount'), finalAfterDiscount=txt('sumAfterDiscount');
    msg+='\nالإجمالي: '+total+' درهم'; if(discount){ msg+='\nالخصم: '+discount+' درهم\nبعد الخصم: '+finalAfterDiscount+' درهم'; } if(notes) msg+='\nملاحظات: '+notes;
    window.open('https://wa.me/971504133032?text='+encodeURIComponent(msg), '_blank');
  }

  // ====== أدوات ======
  function val(id){ const el=document.getElementById(id); return el?el.value:""; }
  function txt(id){ const el=document.getElementById(id); return el?el.innerText:""; }
  function gid(id){ return document.getElementById(id); }
  function escapeHtml(str){ return (str||'').replace(/[&<>"]/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s])); }
  function escapeAttr(str){ return escapeHtml(str).replace(/"/g,'&quot;'); }
</script>
</body>
</html>
